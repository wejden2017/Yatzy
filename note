- name: Ensure PDB is open and state saved
  ansible.builtin.shell: |
    . /home/oracle/.bash_profile
    
    # Check current PDB status
    STATUS=$(sqlplus -s / as sysdba <<'SQL'
    set pages 0 feedback off heading off
    SELECT OPEN_MODE FROM V$PDBS WHERE NAME='{{ pdbs_name | upper }}';
    exit;
    SQL
    )
    
    # If already READ WRITE, nothing to do
    if echo "$STATUS" | grep -q "READ WRITE"; then
      echo "PDB_ALREADY_OPEN"
      exit 0
    fi
    
    # Otherwise, open it and save state
    sqlplus -s / as sysdba <<'SQL'
    ALTER PLUGGABLE DATABASE {{ pdbs_name }} OPEN;
    ALTER PLUGGABLE DATABASE {{ pdbs_name }} SAVE STATE;
    exit;
    SQL
    
    echo "PDB_OPENED_AND_SAVED"
  become: yes
  become_user: oracle
  register: pdb_ensure
  changed_when: "'PDB_OPENED_AND_SAVED' in pdb_ensure.stdout"
  failed_when:
    - pdb_ensure.rc != 0
    - "'ORA-65019' not in pdb_ensure.stdout"
    - "'PDB_ALREADY_OPEN' not in pdb_ensure.stdout"
