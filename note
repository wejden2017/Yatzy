DECLARE
  v_user VARCHAR2(128) := UPPER('{{ item.login }}');
  v_exists NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_exists FROM dba_users WHERE username = v_user;
  
  IF v_exists = 0 THEN
    EXECUTE IMMEDIATE 'CREATE USER ' || v_user || ' IDENTIFIED BY "{{ item.password | default("ChangeMe123!") }}"';
  END IF;
  
  FOR r IN (SELECT privilege FROM dba_sys_privs WHERE grantee = v_user) LOOP
    BEGIN
      EXECUTE IMMEDIATE 'REVOKE ' || r.privilege || ' FROM ' || v_user;
    EXCEPTION WHEN OTHERS THEN NULL;
    END;
  END LOOP;
  
  FOR r IN (SELECT granted_role FROM dba_role_privs WHERE grantee = v_user) LOOP
    BEGIN
      EXECUTE IMMEDIATE 'REVOKE ' || r.granted_role || ' FROM ' || v_user;
    EXCEPTION WHEN OTHERS THEN NULL;
    END;
  END LOOP;
  
  EXECUTE IMMEDIATE 'GRANT CREATE SESSION TO ' || v_user;
  EXECUTE IMMEDIATE 'GRANT SELECT ANY TABLE TO ' || v_user;
  EXECUTE IMMEDIATE 'GRANT SELECT ANY SEQUENCE TO ' || v_user;
  EXECUTE IMMEDIATE 'GRANT EXECUTE ANY PROCEDURE TO ' || v_user;
END;
