- name: Ensure CDB is open
  ansible.builtin.shell: |
    . /home/oracle/.bash_profile
    
    # Check if CDB is already READ WRITE
    STATUS=$(sqlplus -s / as sysdba <<'SQL'
    set pages 0 feedback off heading off
    SELECT OPEN_MODE FROM V$DATABASE;
    exit;
    SQL
    )
    
    # If already READ WRITE, nothing to do
    if echo "$STATUS" | grep -q "READ WRITE"; then
      echo "CDB_ALREADY_OPEN"
      exit 0
    fi
    
    # Try to open the database
    OUTPUT=$(sqlplus -s / as sysdba <<'SQL' 2>&1
    ALTER DATABASE OPEN;
    exit;
    SQL
    )
    
    # If failed because database not started, start it
    if echo "$OUTPUT" | grep -q "ORA-"; then
      sqlplus -s / as sysdba <<'SQL2'
      STARTUP;
      exit;
    SQL2
      echo "CDB_STARTED"
    else
      echo "CDB_OPENED"
    fi
  become: yes
  become_user: oracle
  register: cdb_ensure
  changed_when: "'CDB_OPENED' in cdb_ensure.stdout or 'CDB_STARTED' in cdb_ensure.stdout"
  failed_when:
    - cdb_ensure.rc != 0
    - "'ORA-01081' not in cdb_ensure.stdout"
    - "'ORA-01531' not in cdb_ensure.stdout"
    - "'CDB_ALREADY_OPEN' not in cdb_ensure.stdout"
