1-aws-inject:
  stage: auth
  image: vault:1.13.3
  needs: [1-vault-aws-auth]
  dependencies: [1-vault-aws-auth]
  script:
    - echo "[INFO] Lecture manuelle des credentials Vault dynamiques..."
    - export VAULT_ROLE_PATH="gitlab/app-00451/aws/creds/aws-cats-${DEPLOY_ENVIRONMENT}-developer"

    # Appel Vault pour lire les credentials AWS du bon compte
    - CREDS=$(vault read -format=json "$VAULT_ROLE_PATH")
    - export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r '.data.access_key')
    - export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r '.data.secret_key')
    - export AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r '.data.security_token')
    - export AWS_REGION="eu-west-2"

    # Vérification debug
    - echo "[DEBUG] AWS_ACCOUNT_ID via Vault = $(aws sts get-caller-identity --region $AWS_REGION | jq -r '.Account')"

    # Création du fichier dotenv
    - echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" > aws.env
    - echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> aws.env
    - echo "AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN" >> aws.env
    - echo "AWS_REGION=$AWS_REGION" >> aws.env

  artifacts:
    reports:
      dotenv: aws.env
    expire_in: 1 hour
