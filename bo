Voici la version complète corrigée de ton fichier modules/nlb/main.tf pour que le NLB expose cats-backend sur le port 80 (HTTP), compatible avec API Gateway via VPC Link.

✅ modules/nlb/main.tf (corrigé, propre et prêt à coller)
hcl
Copier
Modifier
resource "aws_lb" "nlb_cats" {
  name               = "${var.entity}-${var.application}-${var.environment}-cats-nlb"
  internal           = true
  load_balancer_type = "network"
  subnets            = var.subnet_ids

  enable_cross_zone_load_balancing = true
  tags                             = var.tags
}

# Target group pour CATS-WEB (port 8080)
resource "aws_lb_target_group" "tg_cats_web" {
  name        = "${var.entity}-${var.application}-${var.environment}-cats-web-tg"
  port        = 8080
  protocol    = "TCP"
  vpc_id      = var.vpc_id
  target_type = "instance"
  tags        = var.tags
}

# Target group pour CATS-BACKEND (port 8081, en HTTP pour API Gateway)
resource "aws_lb_target_group" "tg_cats_backend" {
  name        = "${var.entity}-${var.application}-${var.environment}-cats-backend-tg"
  port        = 8081
  protocol    = "HTTP"  # CHANGÉ : pour que API Gateway accepte via VPC Link
  vpc_id      = var.vpc_id
  target_type = "instance"
  tags        = var.tags

  health_check {
    path                = "/"
    interval            = 30
    timeout             = 5
    healthy_threshold   = 3
    unhealthy_threshold = 3
    matcher             = "200"
  }
}

# Attach EC2 à TG cats-web
resource "aws_lb_target_group_attachment" "tg_attach_web" {
  target_group_arn = aws_lb_target_group.tg_cats_web.arn
  target_id        = var.instance_id
  port             = 8080
}

# Attach EC2 à TG cats-backend
resource "aws_lb_target_group_attachment" "tg_attach_backend" {
  target_group_arn = aws_lb_target_group.tg_cats_backend.arn
  target_id        = var.instance_id
  port             = 8081
}

# Listener HTTP (port 80) pour exposer cats-backend (vers 8081 sur EC2)
resource "aws_lb_listener" "http_backend" {
  load_balancer_arn = aws_lb.nlb_cats.arn
  port              = 80
  protocol          = "HTTP"

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.tg_cats_backend.arn
  }
}
✅ Rappel – À ne PAS faire :
Ne pas utiliser le port 8081 dans uri côté API Gateway

Ne pas utiliser TCP dans le TG backend si tu veux passer par API Gateway

Prochaine étape :
Lance :

bash
Copier
Modifier
terraform apply -target=module.nlb_cats_front
terraform apply -target=module.api_gateway_rest
Et teste ensuite l'URL :

bash
Copier
Modifier
https://<rest-api-id>.execute-api.eu-west-2.amazonaws.com/v1/catsbackend/
Tu veux aussi la version équivalente si tu veux plus tard rajouter le HTTPS (port 443) ?












Rechercher

Recherche approfondie

Créer une image




ChatGPT peut commettre des erreurs. Il est recommandé de vérif
