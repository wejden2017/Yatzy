# Partie 1: Définition des variables globales
variables:
  DEPLOY_ENVIRONMENT:
    value: "dev"
    options:
      - "poc"
      - "dev"
      - "uat"
    description: "Choose deployment environment. Set to 'dev' by default."
  RUNNER_TAG: "app-00451-dev-cicd-gitlab-runner"  # Valeur par défaut

# Partie 2: Configuration du workflow pour définir dynamiquement RUNNER_TAG
workflow:
  rules:
    - if: '$DEPLOY_ENVIRONMENT == "poc"'
      variables:
        RUNNER_TAG: "app-00451-poc-ec2-gitlab-runner"
    - if: '$DEPLOY_ENVIRONMENT == "dev"'
      variables:
        RUNNER_TAG: "app-00451-dev-cicd-gitlab-runner"
    - if: '$DEPLOY_ENVIRONMENT == "uat"'
      variables:
        RUNNER_TAG: "app-00451-uat-ec2-gitlab-runner"
    - when: always

# Partie 3: Définition du template de base pour tous les jobs
.default-runner:
  tags:
    - $RUNNER_TAG
  before_script:
    - echo "Exécution sur le runner avec tag -> $RUNNER_TAG pour environment -> $DEPLOY_ENVIRONMENT"




# Exemple pour un job
1-vault-kv-retriever:
  stage: Vault retrieve
  extends:
    - .default-runner
    - .vault-secret-retriever
  variables:
    VS_SECRET_LIST: |
      SSH_PRIVATE_KEY@gitlab/app-00451/kv/aws-cats-${DEPLOY_ENVIRONMENT}@EC2-KEY-PAIR
      AD_DOMAIN_NAME@gitlab/app-00451/kv/aws-cats-${DEPLOY_ENVIRONMENT}@ad-domain-name
      AD_PASSWORD@gitlab/app-00451/kv/aws-cats-${DEPLOY_ENVIRONMENT}@ad-password
      AD_USERNAME@gitlab/app-00451/kv/aws-cats-${DEPLOY_ENVIRONMENT}@ad-username
      FSX_ADMIN_PASSWORD@gitlab/app-00451/kv/aws-cats-${DEPLOY_ENVIRONMENT}@fsx-admin-password
