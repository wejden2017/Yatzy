#!/bin/bash

# Installer les outils nécessaires
sudo yum install -y socat nc

# Arrêter Apache s'il est en cours d'exécution
sudo systemctl stop httpd

PORT1=8080
PORT2=8081

# Créer des réponses HTTP pour les deux services
cat > /tmp/response_$PORT1.http << EOF
HTTP/1.1 200 OK
Content-Type: text/html

<html><body><h1>Service 1 - Port $PORT1</h1></body></html>
EOF

cat > /tmp/response_$PORT2.http << EOF
HTTP/1.1 200 OK
Content-Type: text/html

<html><body><h1>Service 2 - Port $PORT2</h1></body></html>
EOF

# Tuer les processus netcat précédents s'ils existent
sudo pkill -f "nc -l.*$PORT1" || true
sudo pkill -f "nc -l.*$PORT2" || true

# Lancer netcat en arrière-plan pour le premier port
echo "Démarrage du serveur sur le port $PORT1"
while true; do sudo nc -l $PORT1 < /tmp/response_$PORT1.http; done &
NC_PID_1=$!

# Lancer netcat en arrière-plan pour le deuxième port
echo "Démarrage du serveur sur le port $PORT2"
while true; do sudo nc -l $PORT2 < /tmp/response_$PORT2.http; done &
NC_PID_2=$!

# Attendre quelques secondes pour que les serveurs démarrent
sleep 2

# Vérifier les ports ouverts
echo "Ports en écoute :"
sudo ss -tulpn | grep -E "$PORT1|$PORT2"

# Tester l'accès aux services
echo "Test des services avec curl :"
echo "Test du port $PORT1 :"
curl -v http://localhost:$PORT1
echo "Test du port $PORT2 :"
curl -v http://localhost:$PORT2

echo "Serveurs lancés avec les PIDs $NC_PID_1 et $NC_PID_2"
echo "Pour arrêter les serveurs, exécutez : sudo pkill -f 'nc -l.*$PORT1'; sudo pkill -f 'nc -l.*$PORT2'"
