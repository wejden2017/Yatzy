1-aws-inject:
  stage: auth
  needs: [1-vault-aws-auth]
  dependencies: [1-vault-aws-auth]
  script:
    - echo "Exporting AWS credentials from environment"
    - echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" > aws.env
    - echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> aws.env
    - echo "AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN" >> aws.env
    - echo "AWS_REGION=${AWS_REGION:-eu-west-2}" >> aws.env
  artifacts:
    reports:
      dotenv: aws.env
    expire_in: 1 hour



needs:
  - job: 1-vault-kv-retriever
  - job: 1-aws-inject
  - job: 4-terraform-apply

dependencies:
  - 1-vault-kv-retriever
  - 1-aws-inject
  - 4-terraform-apply
