# Data source pour récupérer toutes les instances avec le tag Protection = "true"
data "aws_instances" "protected" {
  filter {
    name   = "tag:Protection"
    values = ["true"]
  }
  
  filter {
    name   = "instance-state-name"
    values = ["running", "stopped", "stopping", "pending"]
  }
}

# Créer une ressource de protection pour chaque instance taguée
resource "terraform_data" "instance_protection" {
  for_each = toset(data.aws_instances.protected.ids)
  
  lifecycle {
    prevent_destroy = true
  }
  
  # Se déclenche si l'ID de l'instance change
  triggers_replace = [each.key]
  
  # Optionnel : ajouter des métadonnées pour debugging
  input = {
    instance_id = each.key
    protected_at = timestamp()
  }
}
