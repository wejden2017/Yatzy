Solution pour le module vpc_link
1. Modifiez votre fichier modules/vpc_link/main.tf comme suit :
hcl# Créer un groupe de sécurité pour le VPC Link HTTP
resource "aws_security_group" "vpc_link" {
  name        = "${var.entity}-${var.application}-${var.environment}-vpc-link-sg"
  description = "Security group for VPC Link"
  vpc_id      = var.vpc_id

  # Règle entrante - autoriser tout le trafic provenant du VPC
  ingress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = [data.aws_vpc.selected.cidr_block]
    description = "Allow all inbound traffic from VPC"
  }

  # Règle sortante - autoriser tout le trafic
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound traffic"
  }

  tags = merge(
    var.tags,
    {
      Name = "${var.entity}-${var.application}-${var.environment}-vpc-link-sg"
    }
  )
}

# Data source pour obtenir les informations du VPC
data "aws_vpc" "selected" {
  id = var.vpc_id
}

# VPC Link pour API Gateway HTTP
resource "aws_apigatewayv2_vpc_link" "http_vpc_link" {
  name               = "${var.entity}-${var.application}-${var.environment}-cats-vpc-link-http"
  security_group_ids = [aws_security_group.vpc_link.id]
  subnet_ids         = var.subnet_ids
  tags               = var.tags
}
2. Assurez-vous que modules/vpc_link/variables.tf inclut la variable vpc_id :
hclvariable "vpc_id" {
  description = "ID of the VPC where the VPC Link will be created"
  type        = string
}
3. Si vous n'avez pas encore de variable vpc_id dans l'appel à votre module vpc_link dans le fichier main.tf principal, ajoutez-la :
hclmodule "vpc_link_cats" {
  source      = "./modules/vpc_link"
  entity      = var.entity
  application = var.application
  environment = var.environment
  nlb_arn     = module.nlb_cats_front.nlb_arn
  vpc_id      = data.aws_vpc.cats_vpc.id  # Ajoutez cette ligne
  subnet_ids  = data.aws_subnets.ec2_subnets.ids  # Assurez-vous que cette variable existe
  tags        = { Role = "CATS-VPC-LINK" }
}
4. Si vous n'avez pas encore la data source pour le VPC dans votre fichier main.tf principal, ajoutez-la :
hcldata "aws_vpc" "cats_vpc" {
  filter {
    name   = "tag:Name"
    values = ["${var.entity}-${var.application}-vpc"]
  }
}

data "aws_subnets" "ec2_subnets" {
  filter {
    name   = "vpc-id"
    values = [data.aws_vpc.cats_vpc.id]
  }
  
  # Optionnel: filtre pour obtenir uniquement les sous-réseaux privés
  filter {
    name   = "tag:Tier"
    values = ["private"]
  }
}
