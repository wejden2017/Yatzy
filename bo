.before_script_common: &before_script_common
  - pip3 install boto3
  - chmod +x inventory/aws_ec2_inventory.py

  # Supprimer les droits "world-writable" pour que Ansible accepte ansible.cfg
  - chmod o-w $(pwd)

  # Forcer Ansible à utiliser le fichier de config local
  - export ANSIBLE_CONFIG=./ansible.cfg

  # Déchiffrer Vault (si utilisé)
  - echo "$VAULT_PASSWORD" > $ANSIBLE_VAULT_PASSWORD_FILE

  # Générer la clé privée SSH à partir de la variable d'environnement
  - echo "$SSH_PRIVATE_KEY" > ssh_key.pem
  - chmod 600 ssh_key.pem

  # Exporter les credentials AWS
  - export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
  - export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
  - export AWS_REGION="${AWS_REGION}"

  # Exporter l'environnement cible (dev, poc, uat, etc.)
  - export ENV="${ENV}"
