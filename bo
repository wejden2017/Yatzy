#!/bin/sh

# charge l'env CATS (CNX_CATS, LANGUE, CAL_CODE, LOG_*)
. "${HOME}/env/env.ksh"
. "${CATS_OPER}/common_functions.sh"

# logs standard
base_name=`basename "$0" ".sh"`
LOG_SCRIPT="${CATS_LOG}/${base_name}.log"
nom_script=`basename "$0"`
exec 1>>"$LOG_SCRIPT" 2>>"$LOG_SCRIPT"

LOGINFO "${nom_script}" "Début" | tee -a "$LOG_GENERAL"
LOGSTART "${nom_script}"

# -------- paramètres ----------
DATE_IN="$1"
if [ -z "$DATE_IN" ]; then
  LOGERR "${nom_script}" "Usage: $0 <YYYYMMDD>"
  CHECK_RETURN_CODE_CATS "${nom_script}" 1 "Paramètre manquant"
fi

case "$DATE_IN" in
  [0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]) : ;;
  *) LOGERR "${nom_script}" "Format invalide: $DATE_IN (attendu YYYYMMDD)"
     CHECK_RETURN_CODE_CATS "${nom_script}" 2 "Format date KO" ;;
esac

# valeurs par défaut si non définies
LANGUE=${LANGUE:-fr}
CAL_CODE=${CAL_CODE:-070}
CNX_CATS=${CNX_CATS:-"sqlplus -s USER/PASS@SRV"}

# -------- appel Oracle ----------
res=$(${CNX_CATS} <<SQL
set pages 0 feedback off verify off heading off echo off trimspool on
var v_out varchar2(8);
begin
  :v_out :=
    to_char(
      LUCA6.PACK_GESTION_CALENDRIER.CAL_DATE_AVEC_SAMDIM(
        '${LANGUE}', to_date('${DATE_IN}','YYYYMMDD'), '${CAL_CODE}', 1
      ),
      'YYYYMMDD'
    );
end;
/
print :v_out
exit
SQL
)

OUT=`echo "$res" | tr -d '[:space:]'`

if [ -z "$OUT" ]; then
  LOGERR "${nom_script}" "Procédure n'a rien renvoyé pour $DATE_IN"
  CHECK_RETURN_CODE_CATS "${nom_script}" 3 "Procédure Oracle KO"
fi

# affiche le résultat (stdout) + log
echo "$OUT"
LOGINFO "${nom_script}" "CAL_DATE_AVEC_SAMDIM($DATE_IN) -> $OUT"

LOGEND "${nom_script}" "Fin" | tee -a "$LOG_GENERAL"
exit 0
