modules/api_gateway_http/main.tf :
hcl# === Integration pour catsweb ===
resource "aws_apigatewayv2_integration" "catsweb" {
  api_id               = aws_apigatewayv2_api.this.id
  integration_type     = "HTTP_PROXY"
  integration_uri      = var.nlb_listener_arn  # Utilisez l'ARN du LISTENER NLB, pas du Target Group
  integration_method   = "ANY"
  connection_type      = "VPC_LINK"
  connection_id        = var.vpc_link_id
  payload_format_version = "1.0"
}

# === Integration pour catsbackend ===
resource "aws_apigatewayv2_integration" "catsbackend" {
  api_id               = aws_apigatewayv2_api.this.id
  integration_type     = "HTTP_PROXY"
  integration_uri      = var.nlb_listener_arn  # Même chose ici
  integration_method   = "ANY"
  connection_type      = "VPC_LINK"
  connection_id        = var.vpc_link_id
  payload_format_version = "1.0"
}
Dans modules/api_gateway_http/variables.tf, ajoutez :
hclvariable "nlb_listener_arn" {
  description = "ARN of the NLB listener to connect to"
  type        = string
}
2. Correction du NLB Listener Protocol
L'erreur indique que vous essayez de créer un listener HTTP sur un Network Load Balancer (NLB), mais cela n'est pas supporté. Pour un NLB, vous devez utiliser TCP au lieu de HTTP. Modifiez votre fichier modules/nlb/main.tf :
hcl# === Listener HTTP (port 80) ===
resource "aws_lb_listener" "http_router" {
  load_balancer_arn = aws_lb.nlb_cats.arn
  port              = 80
  protocol          = "TCP"  # Changez HTTP en TCP
  
  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.tg_cats_web.arn
  }
}
3. Mise à jour du module main.tf pour passer l'ARN du listener
Dans votre fichier principal où vous appelez le module api_gateway_http, mettez à jour l'appel pour passer l'ARN du listener NLB :
hclmodule "api_gateway_http" {
  source           = "./modules/api_gateway_http"
  name_prefix      = "${var.entity}-${var.application}-${var.environment}-front-api-gateway"
  vpc_link_id      = module.vpc_link_cats.http_vpc_link_id
  catsweb_tg_arn   = module.nlb_cats_front.tg_web_arn
  catsbackend_tg_arn = module.nlb_cats_front.tg_backend_arn
  nlb_listener_arn = module.nlb_cats_front.listener_arn  # Ajoutez cette ligne
  nlb_dns_name     = module.nlb_cats_front.nlb_dns_name
  environment      = var.environment
  common_tags      = local.standard_tags
  tags             = { Role = "CATS-API-GATEWAY-HTTP" }
}
4. Assurez-vous que votre module NLB expose l'ARN du listener
Dans modules/nlb/outputs.tf, ajoutez :
hcloutput "listener_arn" {
  description = "ARN of the HTTP listener"
  value       = aws_lb_listener.http_router.arn
}
Résumé des changements clés
