âœ… 1. Dans le module api_gateway_rest/main.tf
ðŸ”„ Modifie aws_api_gateway_integration "catsweb" :
hcl
Copier
Modifier
resource "aws_api_gateway_integration" "catsweb" {
  rest_api_id             = aws_api_gateway_rest_api.this.id
  resource_id             = aws_api_gateway_resource.catsweb_proxy.id
  http_method             = aws_api_gateway_method.catsweb_any.http_method
  integration_http_method = "ANY"
  type                    = "HTTP_PROXY"
  uri                     = "http://${var.nlb_dns_name}/"  # âœ… Plus de port
  connection_type         = "VPC_LINK"
  connection_id           = var.vpc_link_id
}
ðŸ”„ Modifie aws_api_gateway_integration "catsbackend" :
hcl
Copier
Modifier
resource "aws_api_gateway_integration" "catsbackend" {
  rest_api_id             = aws_api_gateway_rest_api.this.id
  resource_id             = aws_api_gateway_resource.catsbackend_proxy.id
  http_method             = aws_api_gateway_method.catsbackend_any.http_method
  integration_http_method = "ANY"
  type                    = "HTTP_PROXY"
  uri                     = "http://${var.nlb_dns_name}/"  # âœ… Plus de port
  connection_type         = "VPC_LINK"
  connection_id           = var.vpc_link_id
}
âœ… 2. Dans variables.tf de ton module api_gateway_rest
Si ce nâ€™est pas dÃ©jÃ  fait, assure-toi dâ€™avoir :

hcl
Copier
Modifier
variable "nlb_dns_name" {
  description = "NLB DNS name"
  type        = string
}
âœ… 3. Dans le main.tf global (appel du module)
Tu gardes comme Ã§a :

hcl
Copier
Modifier
module "api_gateway_rest" {
  source               = "./modules/api_gateway_rest"
  name_prefix          = "${var.entity}-${var.application}-${var.environment}-front-api-gateway"
  vpc_link_id          = module.vpc_link_cats.vpc_link_id
  catsweb_tg_arn       = module.nlb_cats_front.tg_web_arn
  catsbackend_tg_arn   = module.nlb_cats_front.tg_backend_arn
  environment          = var.environment
  common_tags          = local.standard_tags
  nlb_dns_name         = module.nlb_cats_front.dns_name
  tags = {
    "Role" = "CATS-API-GATEWAY-REST"
  }
}
âœ… 4. Dans le module NLB (modules/nlb/outputs.tf)
Si tu nâ€™as pas encore cet output :

hcl
Copier
Modifier
output "dns_name" {
  value = aws_lb.nlb_cats.dns_name
}
âœ… 5. VÃ©rifie le NLB (ce que tu as dÃ©jÃ  fait)
Tu dois avoir :

Listener TCP:8080 â†’ TG web (port 8080)

Listener TCP:8081 â†’ TG backend (port 8081)

Ã‡a permet de router dynamiquement selon le listener (et donc la route).

âœ… RÃ©sultat attendu

https://.../catsweb/{proxy+} ira sur le port 8080 via le listener 8080

https://.../catsbackend/{proxy+} ira sur le port 8081 via le listener 8081

Dis-moi si tu veux aussi un refactor de ton module nlb ou un contrÃ´le complet de la cohÃ©rence finale.
