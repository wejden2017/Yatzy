- name: Check for critical MQSC errors
  ansible.builtin.set_fact:
    has_critical_error: "{{ mqsc_execution.stdout | regex_search('AMQ[0-9]{4}E') is not none and mqsc_execution.stdout | regex_search('AMQ8150E') is none }}"

- name: Display MQSC execution result
  debug:
    msg: |
      MQSC Execution Summary:
      - Return Code: {{ mqsc_execution.rc }}
      - Queues already existing: {{ (mqsc_execution.stdout | regex_findall('AMQ8150E')) | length }}
      - Other warnings: {{ (mqsc_execution.stdout | regex_findall('AMQ[0-9]{4}W')) | length }}
      - Critical errors: {{ (mqsc_execution.stdout | regex_findall('AMQ[0-9]{4}E') | reject('search', 'AMQ8150E')) | list | length }}

- name: Fail only if critical errors exist (excluding already exists)
  fail:
    msg: "Critical errors found in MQSC execution"
  when: 
    - has_critical_error | bool
    - mqsc_execution.rc not in [0, 10, 20]
