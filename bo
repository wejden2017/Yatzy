#!/bin/bash

# Arrêter tous les services précédents
sudo systemctl stop httpd-8080.service httpd-8081.service 
sudo systemctl disable httpd-8080.service httpd-8081.service

# S'assurer qu'Apache est installé et arrêter le service par défaut
sudo yum install -y httpd
sudo systemctl stop httpd

# Créer des pages HTML simples dans les répertoires par défaut
sudo mkdir -p /var/www/html/port-8080
sudo mkdir -p /var/www/html/port-8081
echo "<html><body><h1>Service 1 - Port 8080</h1></body></html>" | sudo tee /var/www/html/port-8080/index.html
echo "<html><body><h1>Service 2 - Port 8081</h1></body></html>" | sudo tee /var/www/html/port-8081/index.html

# Configurer Apache pour écouter sur les ports 8080 et 8081
sudo cp /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.backup
sudo sed -i 's/Listen 80/Listen 0.0.0.0:8080\nListen 0.0.0.0:8081/' /etc/httpd/conf/httpd.conf

# Créer des VirtualHosts pour les deux ports
cat << 'EOF' | sudo tee /etc/httpd/conf.d/vhosts.conf
<VirtualHost *:8080>
    DocumentRoot "/var/www/html/port-8080"
    <Directory "/var/www/html/port-8080">
        AllowOverride None
        Require all granted
    </Directory>
</VirtualHost>

<VirtualHost *:8081>
    DocumentRoot "/var/www/html/port-8081"
    <Directory "/var/www/html/port-8081">
        AllowOverride None
        Require all granted
    </Directory>
</VirtualHost>
EOF

# Vérifier la configuration
sudo httpd -t

# Démarrer Apache
sudo systemctl start httpd

# Vérifier le statut
sudo systemctl status httpd

# Vérifier si les ports sont ouverts
sudo ss -tulpn | grep httpd

# Tester l'accès aux services
echo "Test des services avec curl :"
echo "Test du port 8080 :"
curl -v http://localhost:8080
echo "Test du port 8081 :"
curl -v http://localhost:8081
