#!/bin/bash

# Mise à jour du système et installation des packages nécessaires
sudo yum update -y
sudo yum install httpd -y

# Arrêter le service Apache par défaut s'il est en cours d'exécution
sudo systemctl stop httpd

# Créer les répertoires pour les deux instances
sudo mkdir -p /etc/httpd-8080/conf
sudo mkdir -p /etc/httpd-8081/conf
sudo mkdir -p /var/www/html-8080
sudo mkdir -p /var/www/html-8081
sudo mkdir -p /var/log/httpd-8080
sudo mkdir -p /var/log/httpd-8081

# Créer un fichier de configuration minimal pour le port 8080
cat << 'EOF' | sudo tee /etc/httpd-8080/conf/httpd.conf
ServerRoot "/etc/httpd"
Listen 8080
ServerName localhost:8080

LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so

TypesConfig /etc/mime.types
AddDefaultCharset UTF-8

DocumentRoot "/var/www/html-8080"
ErrorLog "/var/log/httpd-8080/error_log"
CustomLog "/var/log/httpd-8080/access_log" combined

<Directory "/var/www/html-8080">
    AllowOverride None
    Require all granted
</Directory>

DirectoryIndex index.html
EOF

# Créer un fichier de configuration minimal pour le port 8081
cat << 'EOF' | sudo tee /etc/httpd-8081/conf/httpd.conf
ServerRoot "/etc/httpd"
Listen 8081
ServerName localhost:8081

LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so

TypesConfig /etc/mime.types
AddDefaultCharset UTF-8

DocumentRoot "/var/www/html-8081"
ErrorLog "/var/log/httpd-8081/error_log"
CustomLog "/var/log/httpd-8081/access_log" combined

<Directory "/var/www/html-8081">
    AllowOverride None
    Require all granted
</Directory>

DirectoryIndex index.html
EOF

# Créer des pages HTML simples
echo "<html><body><h1>Service 1 - Port 8080</h1></body></html>" | sudo tee /var/www/html-8080/index.html
echo "<html><body><h1>Service 2 - Port 8081</h1></body></html>" | sudo tee /var/www/html-8081/index.html

# Définir les permissions correctes
sudo chmod -R 755 /var/www/html-8080
sudo chmod -R 755 /var/www/html-8081
sudo chmod -R 755 /var/log/httpd-8080
sudo chmod -R 755 /var/log/httpd-8081
sudo chown -R apache:apache /var/www/html-8080
sudo chown -R apache:apache /var/www/html-8081
sudo chown -R apache:apache /var/log/httpd-8080
sudo chown -R apache:apache /var/log/httpd-8081

# Créer les services systemd
cat << 'EOF' | sudo tee /etc/systemd/system/httpd-8080.service
[Unit]
Description=Apache Web Server on port 8080
After=network.target

[Service]
Type=simple
User=apache
Group=apache
ExecStart=/usr/sbin/httpd -f /etc/httpd-8080/conf/httpd.conf -DFOREGROUND
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

cat << 'EOF' | sudo tee /etc/systemd/system/httpd-8081.service
[Unit]
Description=Apache Web Server on port 8081
After=network.target

[Service]
Type=simple
User=apache
Group=apache
ExecStart=/usr/sbin/httpd -f /etc/httpd-8081/conf/httpd.conf -DFOREGROUND
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# Recharger systemd et démarrer les services
sudo systemctl daemon-reload
sudo systemctl enable httpd-8080.service
sudo systemctl enable httpd-8081.service
sudo systemctl start httpd-8080.service
sudo systemctl start httpd-8081.service

# Afficher le statut des services
echo "Statut du service httpd-8080:"
sudo systemctl status httpd-8080.service
echo "Statut du service httpd-8081:"
sudo systemctl status httpd-8081.service
