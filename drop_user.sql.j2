-- ============================================
-- Oracle User Management - Drop User
-- Environment: {{ lookup('env', 'ENV') | upper }}
-- User: {{ item.login }}
-- Action: DELETE
-- ============================================

SET SERVEROUTPUT ON SIZE UNLIMITED
SET FEEDBACK OFF
SET VERIFY OFF
SET HEADING OFF
SET ECHO OFF

DECLARE 
    v_cnt INTEGER;
BEGIN
    DBMS_OUTPUT.PUT_LINE('========================================');
    DBMS_OUTPUT.PUT_LINE('Dropping user: {{ item.login }}');
    DBMS_OUTPUT.PUT_LINE('========================================');
    DBMS_OUTPUT.PUT_LINE('');
    
    -- VÃ©rifier si l'utilisateur existe
    SELECT COUNT(*) INTO v_cnt FROM dba_users WHERE username = UPPER('{{ item.login }}');
    
    IF v_cnt = 1 THEN
        DBMS_OUTPUT.PUT_LINE('User {{ item.login }} found, proceeding with drop...');
        
        -- Forcer la dÃ©connexion des sessions actives
        FOR session IN (SELECT sid, serial# FROM v$session WHERE username = UPPER('{{ item.login }}')) LOOP
            BEGIN
                EXECUTE IMMEDIATE 'ALTER SYSTEM KILL SESSION ''' || session.sid || ',' || session.serial# || ''' IMMEDIATE';
                DBMS_OUTPUT.PUT_LINE('  âœ“ Killed session: ' || session.sid || ',' || session.serial#);
            EXCEPTION
                WHEN OTHERS THEN
                    DBMS_OUTPUT.PUT_LINE('  âš  Could not kill session: ' || SQLERRM);
            END;
        END LOOP;
        
        -- Supprimer l'utilisateur avec CASCADE
        EXECUTE IMMEDIATE 'DROP USER {{ item.login }} CASCADE';
        DBMS_OUTPUT.PUT_LINE('');
        DBMS_OUTPUT.PUT_LINE('âœ“ User {{ item.login }} dropped successfully');
        DBMS_OUTPUT.PUT_LINE('  (All objects owned by {{ item.login }} were dropped)');
    ELSE
        DBMS_OUTPUT.PUT_LINE('âš  User {{ item.login }} does not exist');
        DBMS_OUTPUT.PUT_LINE('  Nothing to drop');
    END IF;
    
    DBMS_OUTPUT.PUT_LINE('');
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('');
        DBMS_OUTPUT.PUT_LINE('âœ— ERROR dropping user {{ item.login }}:');
        DBMS_OUTPUT.PUT_LINE('  ' || SQLERRM);
        DBMS_OUTPUT.PUT_LINE('');
        RAISE;
END;
/

PROMPT ============================================
PROMPT User: {{ item.login }}
PROMPT Action: DELETE
PROMPT Status: âœ“ COMPLETED
PROMPT ============================================
PROMPT
```

---

## ðŸ”‘ **CaractÃ©ristiques clÃ©s de ces templates**

### **âœ… user_present.sql.j2**

1. **Idempotence** : VÃ©rifie si l'utilisateur existe avant de crÃ©er
2. **Gestion des mots de passe** : Ã‰chappement des quotes `replace("'", "''")`
3. **Gestion des erreurs** : Ignore les erreurs `-1927` (already granted)
4. **Output dÃ©taillÃ©** : Logs clairs avec `DBMS_OUTPUT`
5. **Support multi-actions** : create, reset-password, lock, unlock
6. **Appel de procÃ©dure** : Pour chaque schÃ©ma dans la liste `schemas`
7. **Pas de Docker** : ExÃ©cution directe via sqlplus

### **âœ… drop_user.sql.j2**

1. **SÃ©curitÃ©** : VÃ©rifie l'existence avant de supprimer
2. **Kill sessions** : Termine les sessions actives avant DROP
3. **CASCADE** : Supprime tous les objets du user
4. **Gestion d'erreurs** : Gestion propre si user inexistant
5. **Logs dÃ©taillÃ©s** : Feedback clair Ã  l'utilisateur

---

## ðŸ§ª **Exemple de sortie lors de l'exÃ©cution**

### **CrÃ©ation d'utilisateur :**
```
========================================
Processing user: zouertani
Action: create
========================================

Creating user zouertani...
âœ“ User zouertani created

Granting CREATE SESSION to zouertani...
âœ“ CREATE SESSION granted

Granting role DEV_ROLE to zouertani...
âœ“ Role DEV_ROLE granted

Setting default roles...
âœ“ Default roles set: DEV_ROLE

Granting access to schemas...

----------------------------------------
Schema: LUCA -> User: zouertani
----------------------------------------
âœ“ Access granted on schema LUCA

----------------------------------------
Schema: LUCA3 -> User: zouertani
----------------------------------------
âœ“ Access granted on schema LUCA3

========================================
All schema grants completed
========================================

Unlocking account zouertani...
ðŸ”“ Account zouertani unlocked

============================================
User: zouertani
Action: CREATE
Status: âœ“ COMPLETED
============================================
```

### **Suppression d'utilisateur :**
```
========================================
Dropping user: toto
========================================

User toto found, proceeding with drop...
  âœ“ Killed session: 123,456

âœ“ User toto dropped successfully
  (All objects owned by toto were dropped)

============================================
User: toto
Action: DELETE
Status: âœ“ COMPLETED
============================================
