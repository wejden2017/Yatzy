-- ============================================================================
-- Ã‰TAPE 1 : TRIGGER DE SÃ‰CURITÃ‰
-- Connexion: SYS as SYSDBA
-- ============================================================================

CONNECT sys/password@VOTRE_TNS AS SYSDBA

-- CrÃ©er le trigger qui autorise DROP uniquement sur LUCA
CREATE OR REPLACE TRIGGER SYS.TRG_BLOCK_DROP_EXCEPT_LUCA
BEFORE DROP ON DATABASE
DECLARE
    v_schema      VARCHAR2(128);
    v_object_name VARCHAR2(128);
    v_object_type VARCHAR2(50);
    v_username    VARCHAR2(128);
BEGIN
    v_schema      := ORA_DICT_OBJ_OWNER;
    v_object_name := ORA_DICT_OBJ_NAME;
    v_object_type := ORA_DICT_OBJ_TYPE;
    v_username    := ORA_LOGIN_USER;
    
    -- Autoriser DROP uniquement sur le schÃ©ma LUCA
    -- Exceptions: SYS et SYSTEM peuvent tout faire
    IF v_username NOT IN ('SYS', 'SYSTEM') AND v_schema != 'LUCA' THEN
        RAISE_APPLICATION_ERROR(-20001,
            'â›” SÃ‰CURITÃ‰ : DROP interdit sur le schÃ©ma ' || v_schema || '. ' ||
            'Vous ne pouvez DROP que sur LUCA. ' ||
            '(User: ' || v_username || ', Objet: ' || v_object_type || ' ' || v_object_name || ')');
    END IF;
    
    -- Si le schÃ©ma est LUCA, autoriser l'opÃ©ration
    NULL;
    
EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END;
/

-- âœ… VALIDATION Ã‰TAPE 1
SELECT trigger_name, status, trigger_type 
FROM dba_triggers 
WHERE trigger_name = 'TRG_BLOCK_DROP_EXCEPT_LUCA';

-- RÃ©sultat attendu: 1 ligne avec STATUS = 'ENABLED'


etape 2 :

CREATE ROLE QA_ROLE_ZOI;

-- PrivilÃ¨ges de connexion
GRANT CREATE SESSION TO QA_ROLE_ZOI;
GRANT CONNECT TO QA_ROLE_ZOI;
GRANT RESOURCE TO QA_ROLE_ZOI;

-- PrivilÃ¨ges de crÃ©ation d'objets (dans leur propre schÃ©ma)
GRANT CREATE TABLE TO QA_ROLE_ZOI;
GRANT CREATE VIEW TO QA_ROLE_ZOI;
GRANT CREATE PROCEDURE TO QA_ROLE_ZOI;
GRANT CREATE SEQUENCE TO QA_ROLE_ZOI;
GRANT CREATE SYNONYM TO QA_ROLE_ZOI;
GRANT CREATE TRIGGER TO QA_ROLE_ZOI;
GRANT CREATE TYPE TO QA_ROLE_ZOI;
GRANT CREATE MATERIALIZED VIEW TO QA_ROLE_ZOI;
GRANT CREATE DATABASE LINK TO QA_ROLE_ZOI;

-- â­ PRIVILÃˆGES DDL (protÃ©gÃ©s par le trigger crÃ©Ã© Ã  l'Ã©tape 1)
GRANT ALTER ANY TABLE TO QA_ROLE_ZOI;
GRANT DROP ANY TABLE TO QA_ROLE_ZOI;
GRANT ALTER ANY PROCEDURE TO QA_ROLE_ZOI;
GRANT DROP ANY PROCEDURE TO QA_ROLE_ZOI;
GRANT ALTER ANY SEQUENCE TO QA_ROLE_ZOI;
GRANT DROP ANY SEQUENCE TO QA_ROLE_ZOI;
GRANT DROP ANY VIEW TO QA_ROLE_ZOI;
GRANT DROP ANY TYPE TO QA_ROLE_ZOI;
GRANT DROP ANY MATERIALIZED VIEW TO QA_ROLE_ZOI;
GRANT DROP ANY TRIGGER TO QA_ROLE_ZOI;
GRANT TRUNCATE ANY TABLE TO QA_ROLE_ZOI;

-- PrivilÃ¨ges de consultation du dictionnaire
GRANT SELECT_CATALOG_ROLE TO QA_ROLE_ZOI;
GRANT SELECT ANY DICTIONARY TO QA_ROLE_ZOI;
GRANT ANALYZE ANY TO QA_ROLE_ZOI;

-- AccÃ¨s aux vues dynamiques V$
GRANT SELECT ON V_$SESSION TO QA_ROLE_ZOI;
GRANT SELECT ON V_$SQL TO QA_ROLE_ZOI;
GRANT SELECT ON V_$SQL_PLAN TO QA_ROLE_ZOI;
GRANT SELECT ON V_$SQLAREA TO QA_ROLE_ZOI;
GRANT SELECT ON V_$PARAMETER TO QA_ROLE_ZOI;



CREATE OR REPLACE PROCEDURE LUCA.GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA(
    p_schema_name VARCHAR2 DEFAULT 'LUCA',
    p_role_name   VARCHAR2 DEFAULT 'QA_ROLE_ZOI'
) AS
    v_sql VARCHAR2(4000);
BEGIN
    DBMS_OUTPUT.PUT_LINE('========================================');
    DBMS_OUTPUT.PUT_LINE('DÃ©but des GRANT pour ' || p_role_name || ' sur schÃ©ma ' || p_schema_name);
    DBMS_OUTPUT.PUT_LINE('========================================');
    
    -- ===== TABLES =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- TABLES ---');
    FOR rec IN (SELECT table_name FROM all_tables WHERE owner = UPPER(p_schema_name)) LOOP
        BEGIN
            v_sql := 'GRANT ALL PRIVILEGES ON ' || p_schema_name || '.' || rec.table_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ Table: ' || rec.table_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('âœ— Erreur table ' || rec.table_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    -- ===== VUES =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- VUES ---');
    FOR rec IN (SELECT view_name FROM all_views WHERE owner = UPPER(p_schema_name)) LOOP
        BEGIN
            v_sql := 'GRANT SELECT ON ' || p_schema_name || '.' || rec.view_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ Vue: ' || rec.view_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('âœ— Erreur vue ' || rec.view_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    -- ===== SEQUENCES =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- SEQUENCES ---');
    FOR rec IN (SELECT sequence_name FROM all_sequences WHERE sequence_owner = UPPER(p_schema_name)) LOOP
        BEGIN
            v_sql := 'GRANT SELECT, ALTER ON ' || p_schema_name || '.' || rec.sequence_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ Sequence: ' || rec.sequence_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('âœ— Erreur sequence ' || rec.sequence_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    -- ===== PROCEDURES, FUNCTIONS, PACKAGES, TYPES =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- PROCEDURES/FUNCTIONS/PACKAGES/TYPES ---');
    FOR rec IN (SELECT object_name, object_type FROM all_objects
                WHERE owner = UPPER(p_schema_name)
                  AND object_type IN ('PROCEDURE', 'FUNCTION', 'PACKAGE', 'TYPE')) LOOP
        BEGIN
            v_sql := 'GRANT EXECUTE ON ' || p_schema_name || '.' || rec.object_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ ' || rec.object_type || ': ' || rec.object_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('âœ— Erreur ' || rec.object_type || ' ' || rec.object_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    -- ===== MATERIALIZED VIEWS =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- MATERIALIZED VIEWS ---');
    FOR rec IN (SELECT mview_name FROM all_mviews WHERE owner = UPPER(p_schema_name)) LOOP
        BEGIN
            v_sql := 'GRANT SELECT ON ' || p_schema_name || '.' || rec.mview_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ MView: ' || rec.mview_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('âœ— Erreur mview ' || rec.mview_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('========================================');
    DBMS_OUTPUT.PUT_LINE('âœ… PrivilÃ¨ges accordÃ©s avec succÃ¨s sur le schÃ©ma ' || p_schema_name);
    DBMS_OUTPUT.PUT_LINE('========================================');
    
END GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA;
/

-- âœ… VALIDATION Ã‰TAPE 3
SELECT object_name, object_type, status 
FROM user_objects 
WHERE object_name = 'GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA';
-- RÃ©sultat attendu: 1 ligne avec STATUS = 'VALID'

Ã‰TAPE 4 : CrÃ©er le user ZOUERTANI et lui affecter le rÃ´le
Ã€ exÃ©cuter en tant que : SYS ou SYSDBA
sql-- ============================================================================
-- Ã‰TAPE 4 : CRÃ‰ATION DU USER ZOUERTANI
-- Connexion: SYS as SYSDBA
-- ============================================================================

CONNECT sys/password@VOTRE_TNS AS SYSDBA

-- CrÃ©er le user
CREATE USER zouertani 
IDENTIFIED BY "MotDePasse123!" 
DEFAULT TABLESPACE USERS 
TEMPORARY TABLESPACE TEMP
QUOTA UNLIMITED ON USERS;

-- Affecter le rÃ´le
GRANT QA_ROLE_ZOI TO zouertani;

-- RÃ´le par dÃ©faut
ALTER USER zouertani DEFAULT ROLE QA_ROLE_ZOI;

-- âœ… VALIDATION Ã‰TAPE 4
SELECT username, account_status, default_tablespace 
FROM dba_users 
WHERE username = 'ZOUERTANI';
-- RÃ©sultat attendu: 1 ligne avec ACCOUNT_STATUS = 'OPEN'

SELECT grantee, granted_role 
FROM dba_role_privs 
WHERE grantee = 'ZOUERTANI';
-- RÃ©sultat attendu: 1 ligne avec GRANTED_ROLE = 'QA_ROLE_ZOI'

Ã‰TAPE 5 : ExÃ©cuter la procÃ©dure pour donner les grants sur objets existants
Ã€ exÃ©cuter en tant que : LUCA
sql-- ============================================================================
-- Ã‰TAPE 5 : EXÃ‰CUTION DE LA PROCÃ‰DURE DE GRANT
-- Connexion: LUCA
-- ============================================================================

CONNECT luca/password@VOTRE_TNS

SET SERVEROUTPUT ON SIZE UNLIMITED

-- ExÃ©cuter la procÃ©dure
EXEC LUCA.GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA('LUCA', 'QA_ROLE_ZOI');

-- âœ… VALIDATION Ã‰TAPE 5
-- VÃ©rifier que le rÃ´le a bien les privilÃ¨ges sur les objets de LUCA
SELECT table_name, privilege 
FROM dba_tab_privs 
WHERE grantee = 'QA_ROLE_ZOI' AND owner = 'LUCA'
ORDER BY table_name, privilege;
-- RÃ©sultat attendu: Liste des objets avec leurs privilÃ¨ges

Ã‰TAPE 6 : TESTS COMPLETS
Test 6A : CrÃ©er une table de test avec LUCA
sql-- ============================================================================
-- TEST 6A : CRÃ‰ATION TABLE AVEC LUCA
-- Connexion: LUCA
-- ============================================================================

CONNECT luca/password@VOTRE_TNS

-- CrÃ©er une table de test
CREATE TABLE LUCA.TEST_DROP_TABLE (
    id NUMBER PRIMARY KEY,
    nom VARCHAR2(100),
    date_creation DATE DEFAULT SYSDATE
);

-- InsÃ©rer des donnÃ©es
INSERT INTO LUCA.TEST_DROP_TABLE VALUES (1, 'Test 1', SYSDATE);
INSERT INTO LUCA.TEST_DROP_TABLE VALUES (2, 'Test 2', SYSDATE);
COMMIT;

-- âœ… VALIDATION 6A
SELECT * FROM LUCA.TEST_DROP_TABLE;
-- RÃ©sultat attendu: 2 lignes
Test 6B : VÃ©rifier que ZOUERTANI peut voir la table
sql-- ============================================================================
-- TEST 6B : SELECT AVEC ZOUERTANI
-- Connexion: ZOUERTANI
-- ============================================================================

CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- âš ï¸ IMPORTANT : La table vient d'Ãªtre crÃ©Ã©e, elle n'aura pas les grants automatiques
-- car on n'a pas encore crÃ©Ã© le trigger DDL !
-- Pour ce test, on doit exÃ©cuter manuellement le grant

-- Retourner en LUCA pour donner les grants
CONNECT luca/password@VOTRE_TNS

GRANT ALL PRIVILEGES ON LUCA.TEST_DROP_TABLE TO QA_ROLE_ZOI;

-- Revenir en ZOUERTANI
CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- âœ… VALIDATION 6B
SELECT * FROM LUCA.TEST_DROP_TABLE;
-- RÃ©sultat attendu: 2 lignes

-- Test INSERT
INSERT INTO LUCA.TEST_DROP_TABLE VALUES (3, 'Test par ZOUERTANI', SYSDATE);
COMMIT;

SELECT * FROM LUCA.TEST_DROP_TABLE;
-- RÃ©sultat attendu: 3 lignes
Test 6C : Modifier la structure de la table (ALTER)
sql-- ============================================================================
-- TEST 6C : ALTER TABLE AVEC ZOUERTANI
-- Connexion: ZOUERTANI
-- ============================================================================

CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- Ajouter une colonne
ALTER TABLE LUCA.TEST_DROP_TABLE ADD (email VARCHAR2(100));

-- âœ… VALIDATION 6C
DESC LUCA.TEST_DROP_TABLE
-- RÃ©sultat attendu: La colonne 'email' doit apparaÃ®tre

-- Test UPDATE
UPDATE LUCA.TEST_DROP_TABLE SET email = 'test@example.com' WHERE id = 1;
COMMIT;

SELECT * FROM LUCA.TEST_DROP_TABLE WHERE id = 1;
-- RÃ©sultat attendu: email = 'test@example.com'
Test 6D : Supprimer la table (DROP) - LE TEST CRUCIAL
sql-- ============================================================================
-- TEST 6D : DROP TABLE SUR LUCA (DOIT RÃ‰USSIR)
-- Connexion: ZOUERTANI
-- ============================================================================

CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- Tenter de DROP la table de LUCA - DOIT RÃ‰USSIR
DROP TABLE LUCA.TEST_DROP_TABLE PURGE;

-- âœ… VALIDATION 6D
SELECT table_name FROM all_tables WHERE owner = 'LUCA' AND table_name = 'TEST_DROP_TABLE';
-- RÃ©sultat attendu: Aucune ligne (la table est supprimÃ©e)

DBMS_OUTPUT.PUT_LINE('âœ… TEST RÃ‰USSI : DROP sur LUCA autorisÃ©');
Test 6E : Tenter de DROP une table SYS (DOIT ÃŠTRE BLOQUÃ‰)
sql-- ============================================================================
-- TEST 6E : DROP TABLE SUR SYS (DOIT ÃŠTRE BLOQUÃ‰ PAR LE TRIGGER)
-- Connexion: ZOUERTANI
-- ============================================================================

CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- CrÃ©er d'abord une petite table de test dans le schÃ©ma SYSTEM pour le test
-- (On ne peut pas crÃ©er dans SYS, donc on va tester avec SYSTEM)

-- En tant que SYS, crÃ©er une table de test dans SYSTEM
CONNECT sys/password@VOTRE_TNS AS SYSDBA

CREATE TABLE SYSTEM.TEST_PROTECTION (id NUMBER);

-- Retourner en ZOUERTANI
CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- Tenter de DROP cette table - DOIT ÃŠTRE BLOQUÃ‰
DROP TABLE SYSTEM.TEST_PROTECTION;

-- âŒ RÃ‰SULTAT ATTENDU : 
-- ORA-20001: â›” SÃ‰CURITÃ‰ : DROP interdit sur le schÃ©ma SYSTEM. 
-- Vous ne pouvez DROP que sur LUCA. (User: ZOUERTANI, Objet: TABLE TEST_PROTECTION)

-- Si vous voyez cette erreur, LE TEST EST RÃ‰USSI ! âœ…

-- Nettoyer en tant que SYS
CONNECT sys/password@VOTRE_TNS AS SYSDBA
DROP TABLE SYSTEM.TEST_PROTECTION PURGE;

Ã‰TAPE 7 : CrÃ©er le trigger DDL pour auto-grant sur nouveaux objets
Ã€ exÃ©cuter en tant que : LUCA
sql-- ============================================================================
-- Ã‰TAPE 7 : TRIGGER DDL AUTO-GRANT
-- Connexion: LUCA
-- ============================================================================

CONNECT luca/password@VOTRE_TNS

CREATE OR REPLACE TRIGGER LUCA.TRG_AUTO_GRANT_QA_ON_CREATE
AFTER CREATE ON LUCA.SCHEMA
DECLARE
    v_obj_type VARCHAR2(50);
    v_obj_name VARCHAR2(128);
    v_sql      VARCHAR2(4000);
BEGIN
    v_obj_type := ORA_DICT_OBJ_TYPE;
    v_obj_name := ORA_DICT_OBJ_NAME;
    
    DBMS_OUTPUT.PUT_LINE('ðŸ”” Nouvel objet crÃ©Ã©: ' || v_obj_type || ' ' || v_obj_name);
    
    CASE v_obj_type
        
        -- TABLES : ALL PRIVILEGES
        WHEN 'TABLE' THEN
            v_sql := 'GRANT ALL PRIVILEGES ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT ALL PRIVILEGES sur table ' || v_obj_name);
            
        -- VUES : SELECT
        WHEN 'VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT SELECT sur vue ' || v_obj_name);
            
        -- MATERIALIZED VIEWS
        WHEN 'MATERIALIZED VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT SELECT sur mview ' || v_obj_name);
            
        -- SEQUENCES
        WHEN 'SEQUENCE' THEN
            v_sql := 'GRANT SELECT, ALTER ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT SELECT, ALTER sur sequence ' || v_obj_name);
            
        -- PROCEDURES/FUNCTIONS/PACKAGES/TYPES
        WHEN 'PROCEDURE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT EXECUTE sur procedure ' || v_obj_name);
            
        WHEN 'FUNCTION' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT EXECUTE sur function ' || v_obj_name);
            
        WHEN 'PACKAGE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT EXECUTE sur package ' || v_obj_name);
            
        WHEN 'TYPE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT EXECUTE sur type ' || v_obj_name);
            
        ELSE
            DBMS_OUTPUT.PUT_LINE('â„¹ Type ' || v_obj_type || ' ignorÃ©');
    END CASE;
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('âœ— Erreur auto-grant sur ' || v_obj_name || ': ' || SQLERRM);
        NULL; -- Ne pas bloquer la crÃ©ation de l'objet
END;
/

-- âœ… VALIDATION Ã‰TAPE 7
SELECT trigger_name, status, trigger_type 
FROM user_triggers 
WHERE trigger_name = 'TRG_AUTO_GRANT_QA_ON_CREATE';
-- RÃ©sultat attendu: 1 ligne avec STATUS = 'ENABLED'

Ã‰TAPE 8 : Test du trigger DDL auto-grant
sql-- ============================================================================
-- TEST 8 : TRIGGER DDL AUTO-GRANT
-- ============================================================================

-- En tant que LUCA, crÃ©er une nouvelle table
CONNECT luca/password@VOTRE_TNS

SET SERVEROUTPUT ON SIZE UNLIMITED

CREATE TABLE LUCA.TEST_AUTO_GRANT (
    id NUMBER PRIMARY KEY,
    description VARCHAR2(200)
);

-- Le trigger devrait afficher:
-- ðŸ”” Nouvel objet crÃ©Ã©: TABLE TEST_AUTO_GRANT
-- âœ“ GRANT ALL PRIVILEGES sur table TEST_AUTO_GRANT

-- En tant que ZOUERTANI, vÃ©rifier l'accÃ¨s immÃ©diat
CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- âœ… VALIDATION 8A : SELECT doit fonctionner immÃ©diatement
SELECT * FROM LUCA.TEST_AUTO_GRANT;
-- RÃ©sultat attendu: 0 lignes (table vide mais accessible)

-- âœ… VALIDATION 8B : INSERT doit fonctionner
INSERT INTO LUCA.TEST_AUTO_GRANT VALUES (1, 'Test auto-grant');
COMMIT;

-- âœ… VALIDATION 8C : UPDATE doit fonctionner
UPDATE LUCA.TEST_AUTO_GRANT SET description = 'ModifiÃ©' WHERE id = 1;
COMMIT;

-- âœ… VALIDATION 8D : DELETE doit fonctionner
DELETE FROM LUCA.TEST_AUTO_GRANT WHERE id = 1;
COMMIT;

-- âœ… VALIDATION 8E : ALTER doit fonctionner
ALTER TABLE LUCA.TEST_AUTO_GRANT ADD (date_creation DATE);

-- âœ… VALIDATION 8F : DROP doit fonctionner
DROP TABLE LUCA.TEST_AUTO_GRANT PURGE;

DBMS_OUTPUT.PUT_LINE('âœ… TOUS LES TESTS AUTO-GRANT RÃ‰USSIS !');

ðŸ“‹ CHECKLIST FINALE AVANT ANSIBLE
VÃ©rifiez que tous ces tests sont âœ… :
sql-- ============================================================================
-- CHECKLIST FINALE
-- ============================================================================

-- 1. Trigger de sÃ©curitÃ© existe et est activÃ©
SELECT trigger_name, status FROM dba_triggers 
WHERE trigger_name = 'TRG_BLOCK_DROP_EXCEPT_LUCA';
-- âœ… Attendu: 1 ligne, STATUS = 'ENABLED'

-- 2. RÃ´le QA_ROLE_ZOI existe
SELECT role FROM dba_roles WHERE role = 'QA_ROLE_ZOI';
-- âœ… Attendu: 1 ligne

-- 3. RÃ´le a les privilÃ¨ges DROP ANY TABLE
SELECT privilege FROM dba_sys_privs 
WHERE grantee = 'QA_ROLE_ZOI' AND privilege LIKE '%DROP%';
-- âœ… Attendu: Plusieurs lignes dont 'DROP ANY TABLE'

-- 4. User ZOUERTANI existe et a le rÃ´le
SELECT username, account_status FROM dba_users WHERE username = 'ZOUERTANI';
SELECT grantee, granted_role FROM dba_role_privs WHERE grantee = 'ZOUERTANI';
-- âœ… Attendu: ZOUERTANI avec rÃ´le QA_ROLE_ZOI

-- 5. ProcÃ©dure GRANT existe et est valide
SELECT object_name, status FROM dba_objects 
WHERE owner = 'LUCA' AND object_name = 'GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA';
-- âœ… Attendu: STATUS = 'VALID'

-- 6. Trigger DDL existe et est activÃ©
SELECT trigger_name, status FROM dba_triggers 
WHERE owner = 'LUCA' AND trigger_name = 'TRG_AUTO_GRANT_QA_ON_CREATE';
-- âœ… Attendu: STATUS = 'ENABLED'

-- 7. Test DROP sur LUCA rÃ©ussit
-- 8. Test DROP sur SYS/SYSTEM Ã©choue avec ORA-20001
-- 9. Test auto-grant sur nouveau objet rÃ©ussit

ðŸš€ SI TOUS LES TESTS SONT âœ…, VOUS POUVEZ PASSER Ã€ ANSIBLE !
RÃ©sumÃ© de ce qui fonctionne maintenant :

âœ… ZOUERTANI peut SELECT, INSERT, UPDATE, DELETE sur les tables de LUCA
âœ… ZOUERTANI peut ALTER les tables de LUCA
âœ… ZOUERTANI peut DROP les tables de LUCA
âœ… ZOUERTANI NE PEUT PAS DROP les tables de SYS/SYSTEM (bloquÃ© par trigger)
âœ… Les nouveaux objets crÃ©Ã©s par LUCA reÃ§oivent automatiquement les grants

SELECT line, position, text
FROM dba_errors
WHERE owner = 'SYS' 
  AND name = 'TRG_BLOCK_DROP_EXCEPT_LUCA'
ORDER BY sequence;

-- ============================================================================
-- TRIGGER CORRIGÃ‰ - Version sans / Ã  l'intÃ©rieur
-- Ã€ exÃ©cuter en tant que: SYS as SYSDBA
-- ============================================================================

CONNECT sys/password@VOTRE_TNS AS SYSDBA

-- Supprimer l'ancien trigger invalide
DROP TRIGGER SYS.TRG_BLOCK_DROP_EXCEPT_LUCA;

-- CrÃ©er le trigger corrigÃ© (ATTENTION: pas de / dans le code)
CREATE OR REPLACE TRIGGER SYS.TRG_BLOCK_DROP_EXCEPT_LUCA
BEFORE DROP ON DATABASE
DECLARE
    v_schema      VARCHAR2(128);
    v_username    VARCHAR2(128);
    v_object_name VARCHAR2(128);
    v_object_type VARCHAR2(50);
BEGIN
    v_schema      := SYS.DICTIONARY_OBJ_OWNER;
    v_username    := SYS.LOGIN_USER;
    v_object_name := SYS.DICTIONARY_OBJ_NAME;
    v_object_type := SYS.DICTIONARY_OBJ_TYPE;
    
    IF v_username IN ('SYS', 'SYSTEM') THEN
        RETURN;
    END IF;
    
    IF v_schema != 'LUCA' THEN
        RAISE_APPLICATION_ERROR(-20001,
            'SECURITE: DROP interdit sur le schema ' || v_schema || '. ' ||
            'Vous ne pouvez DROP que sur LUCA. ' ||
            '(User: ' || v_username || ', Objet: ' || v_object_type || ' ' || v_object_name || ')');
    END IF;
    
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -20001 THEN
            RAISE;
        ELSE
            NULL;
        END IF;
END TRG_BLOCK_DROP_EXCEPT_LUCA;



ðŸ”§ SOLUTION : Utiliser PRAGMA AUTONOMOUS_TRANSACTION
Le trigger doit s'exÃ©cuter dans une transaction autonome pour pouvoir faire des GRANT.
Voici le trigger corrigÃ© :
sql-- ============================================================================
-- TRIGGER AUTO-GRANT CORRIGÃ‰ avec AUTONOMOUS_TRANSACTION
-- Ã€ exÃ©cuter en tant que: LUCA
-- ============================================================================

CONNECT luca/password@VOTRE_TNS

-- Supprimer l'ancien trigger
DROP TRIGGER LUCA.TRG_AUTO_GRANT_QA_ON_CREATE;

-- CrÃ©er le trigger avec transaction autonome
CREATE OR REPLACE TRIGGER LUCA.TRG_AUTO_GRANT_QA_ON_CREATE
AFTER CREATE ON LUCA.SCHEMA
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;  -- â­ CRUCIAL !
    
    v_obj_type VARCHAR2(50);
    v_obj_name VARCHAR2(128);
    v_sql      VARCHAR2(4000);
BEGIN
    v_obj_type := ORA_DICT_OBJ_TYPE;
    v_obj_name := ORA_DICT_OBJ_NAME;
    
    DBMS_OUTPUT.PUT_LINE('ðŸ”” Nouvel objet crÃ©Ã©: ' || v_obj_type || ' ' || v_obj_name);
    
    CASE v_obj_type
        
        WHEN 'TABLE' THEN
            v_sql := 'GRANT ALL PRIVILEGES ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT ALL PRIVILEGES sur table ' || v_obj_name);
            
        WHEN 'VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT SELECT sur vue ' || v_obj_name);
            
        WHEN 'MATERIALIZED VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT SELECT sur mview ' || v_obj_name);
            
        WHEN 'SEQUENCE' THEN
            v_sql := 'GRANT SELECT, ALTER ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT SELECT, ALTER sur sequence ' || v_obj_name);
            
        WHEN 'PROCEDURE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT EXECUTE sur procedure ' || v_obj_name);
            
        WHEN 'FUNCTION' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT EXECUTE sur function ' || v_obj_name);
            
        WHEN 'PACKAGE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT EXECUTE sur package ' || v_obj_name);
            
        WHEN 'TYPE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('âœ“ GRANT EXECUTE sur type ' || v_obj_name);
            
        ELSE
            DBMS_OUTPUT.PUT_LINE('â„¹ Type ' || v_obj_type || ' ignorÃ©');
    END CASE;
    
    COMMIT;  -- â­ IMPORTANT : Commiter la transaction autonome
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('âœ— Erreur auto-grant sur ' || v_obj_name || ': ' || SQLERRM);
        ROLLBACK;  -- Rollback en cas d'erreur
        -- Ne pas propager l'erreur pour ne pas bloquer la crÃ©ation de l'objet
END TRG_AUTO_GRANT_QA_ON_CREATE;
/

-- âœ… VÃ‰RIFIER
SELECT trigger_name, status 
FROM user_triggers 
WHERE trigger_name = 'TRG_AUTO_GRANT_QA_ON_CREATE';
-- RÃ©sultat attendu: STATUS = 'ENABLED'


-- ============================================================================
-- TRIGGER AUTO-GRANT AVEC DBMS_JOB (solution au deadlock)
-- Ã€ exÃ©cuter en tant que: LUCA
-- ============================================================================

CONNECT luca/password@VOTRE_TNS

-- Supprimer l'ancien trigger
DROP TRIGGER LUCA.TRG_AUTO_GRANT_QA_ON_CREATE;

-- CrÃ©er le trigger avec job diffÃ©rÃ©
CREATE OR REPLACE TRIGGER LUCA.TRG_AUTO_GRANT_QA_ON_CREATE
AFTER CREATE ON LUCA.SCHEMA
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;
    
    v_obj_type VARCHAR2(50);
    v_obj_name VARCHAR2(128);
    v_job_id   NUMBER;
    v_sql      VARCHAR2(4000);
BEGIN
    v_obj_type := ORA_DICT_OBJ_TYPE;
    v_obj_name := ORA_DICT_OBJ_NAME;
    
    DBMS_OUTPUT.PUT_LINE('ðŸ”” Nouvel objet crÃ©Ã©: ' || v_obj_type || ' ' || v_obj_name);
    
    -- Construire la commande GRANT selon le type d'objet
    CASE v_obj_type
        WHEN 'TABLE' THEN
            v_sql := 'GRANT ALL PRIVILEGES ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            
        WHEN 'VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            
        WHEN 'MATERIALIZED VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            
        WHEN 'SEQUENCE' THEN
            v_sql := 'GRANT SELECT, ALTER ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            
        WHEN 'PROCEDURE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            
        WHEN 'FUNCTION' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            
        WHEN 'PACKAGE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            
        WHEN 'TYPE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            
        ELSE
            v_sql := NULL;
    END CASE;
    
    -- Si un GRANT est nÃ©cessaire, crÃ©er un job pour l'exÃ©cuter dans 2 secondes
    IF v_sql IS NOT NULL THEN
        DBMS_JOB.SUBMIT(
            job       => v_job_id,
            what      => 'BEGIN EXECUTE IMMEDIATE ''' || v_sql || '''; END;',
            next_date => SYSDATE + (2/86400),  -- +2 secondes
            interval  => NULL  -- Job one-time
        );
        
        COMMIT;  -- NÃ©cessaire pour valider le job
        
        DBMS_OUTPUT.PUT_LINE('âœ“ Job ' || v_job_id || ' crÃ©Ã© pour GRANT sur ' || v_obj_name);
    END IF;
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('âœ— Erreur: ' || SQLERRM);
        ROLLBACK;
END TRG_AUTO_GRANT_QA_ON_CREATE;
/

-- âœ… VÃ‰RIFIER
SELECT trigger_name, status 
FROM user_triggers 
WHERE trigger_name = 'TRG_AUTO_GRANT_QA_ON_CREATE';
