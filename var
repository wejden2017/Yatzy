---

- name: Ensure Docker is installed
  package:
    name: docker
    state: present

- name: Enable and start Docker service
  systemd:
    name: docker
    enabled: true
    state: started

- name: Add ec2-user to docker group
  user:
    name: ec2-user
    groups: docker
    append: yes

- name: Create docker.service.d directory
  file:
    path: /etc/systemd/system/docker.service.d
    state: directory
    mode: '0755'

- name: Add Docker proxy config
  template:
    src: http-proxy.conf.j2
    dest: /etc/systemd/system/docker.service.d/http-proxy.conf
    mode: '0644'

- name: Add Docker override config
  template:
    src: override.conf.j2
    dest: /etc/systemd/system/docker.service.d/override.conf
    mode: '0644'

- name: Reload systemd daemon
  command: systemctl daemon-reexec

- name: Reload systemd services
  command: systemctl daemon-reload

- name: Restart Docker
  systemd:
    name: docker
    state: restarted

- name: Mark Docker as successfully configured
  set_fact:
    docker_ready: true
