#!/bin/ksh

. ${HOME}/env/env.ksh
. ${CATS_OPER}/common_functions.sh

LOG_SCRIPT=${CATS_LOG}/`basename $0 ".ksh"`.log
nom_script=`basename $0 "@@"`
exec 1>>"$LOG_SCRIPT" 2>>"$LOG_SCRIPT"

LOGINFO "${nom_script}" "Début" | tee -a "$LOG_GENERAL"
LOGSTART "${nom_script}"

# Etape 1
if [ $# -ne 1 ]; then
  LOGERR "${nom_script}" "Usage: $0 <OTC|CDS|DCL>"
  CHECK_RETURN_CODE_CATS "${nom_script}" 1 "Paramètre manquant"
fi

# Etape 2
PARAMETRE1="$1"
PARAMETRE_MINUSCULE=$(echo "$PARAMETRE1" | tr '[:upper:]' '[:lower:]')

# Etape 3
case "$PARAMETRE1" in
  OTC) FICHIER_PREAVI="${DATA_APF}/preavi_otc.csv" ;;
  CDS) FICHIER_PREAVI="${DATA_APF}/preavi_cds.csv" ;;
  DCL) FICHIER_PREAVI="${DATA_APF}/preavi_dcl.csv" ;;
  *)   LOGERR "${nom_script}" "Paramètre invalide: $PARAMETRE1"
       CHECK_RETURN_CODE_CATS "${nom_script}" 2 "Paramètre invalide"
       ;;
esac

# Etape 4
if [ -f "$FICHIER_PREAVI" ]; then
  base="${FICHIER_PREAVI%.*}"
  ext="${FICHIER_PREAVI##*.}"
  archive="${base}_$(date '+%Y%m%d').${ext}"
  mv "$FICHIER_PREAVI" "$archive"
  LOGINFO "${nom_script}" "Ancien fichier renommé: $(basename "$archive")"
fi

# Etape 5
FICHIER="$FICHIER_PREAVI"
LOGINFO "${nom_script}" "FICHIER=$FICHIER (param=${PARAMETRE_MINUSCULE})"

# Etape 6 ne pas faire

# Etape 7
"${SHELL_REP}/CARS_chargement_preavis.ksh" "$PARAMETRE1"
rc=$?

if [ $rc -ne 0 ]; then
  LOGERR "${nom_script}" "CARS_chargement_preavis.ksh KO (rc=$rc)"
  CHECK_RETURN_CODE_CATS "${nom_script}" $rc "Chargement préavis échoué"
else
  LOGINFO "${nom_script}" "CARS_chargement_preavis.ksh OK (rc=$rc)"
fi

LOGEND "${nom_script}" "Fin" | tee -a "$LOG_GENERAL"
exit 0
