- name: Apply MQSC configuration
  command: >
    docker exec -i {{ ibmmq_container_name }}
    runmqsc {{ ibmmq_mq_name }}
  args:
    stdin: "{{ lookup('template', 'config.mqsc.j2') }}"
  register: mqsc_result
  failed_when: mqsc_result.rc not in [0, 10]   # 10 = warnings (ex: object exists)

---
- name: Create MQSC config directory
  ansible.builtin.file:
    path: /opt/ibmmq/config
    state: directory
    owner: '1001'
    group: '0'
    mode: '0770'

- name: Check if config.mqsc exists and its type
  ansible.builtin.stat:
    path: /opt/ibmmq/config/config.mqsc
  register: config_mqsc_stat

- name: Remove config.mqsc if it's a directory (cleanup)
  ansible.builtin.file:
    path: /opt/ibmmq/config/config.mqsc
    state: absent
  when: 
    - config_mqsc_stat.stat.exists | default(false)
    - config_mqsc_stat.stat.isdir | default(false)

- name: Deploy MQSC configuration file
  ansible.builtin.template:
    src: config.mqsc.j2
    dest: /opt/ibmmq/config/config.mqsc
    owner: '1001'
    group: '0'
    mode: '0640'
    force: yes


- name: Wait for IBM MQ to be fully ready
  ansible.builtin.command: >
    docker exec {{ ibmmq_container_name }}
    bash -c "while ! echo 'DISPLAY QMGR' | runmqsc {{ ibmmq_mq_name }} > /dev/null 2>&1; do sleep 2; done"
  register: mq_ready
  retries: 30
  delay: 2
  until: mq_ready.rc == 0
  changed_when: false

- name: Apply MQSC configuration to create queues
  ansible.builtin.shell: >
    docker exec {{ ibmmq_container_name }}
    bash -c "runmqsc {{ ibmmq_mq_name }} < /etc/mqm/99-custom.mqsc"
  register: mqsc_apply_result
  changed_when: "'AMQ8006I' in mqsc_apply_result.stdout"
  failed_when: 
    - mqsc_apply_result.rc != 0
    - "'AMQ8405W' not in mqsc_apply_result.stdout"

- name: Display MQSC execution result
  debug:
    var: mqsc_apply_result.stdout_lines
