---
- name: "Créer Security Descriptor simple pour Administrator"
  shell: |
    sshpass -p "n7O3DkkuCz711WCA" ssh -o StrictHostKeyChecking=no fsxadmin@10.105.57.94 \
    "vserver security file-directory ntfs create -vserver cats-svm -ntfs-sd ADMIN_SD"
  register: create_sd_result
  ignore_errors: yes
  delegate_to: localhost
  tags: [netapp_perms]

- name: "Ajouter permissions pour Administrator"
  shell: |
    sshpass -p "n7O3DkkuCz711WCA" ssh -o StrictHostKeyChecking=no fsxadmin@10.105.57.94 \
    "vserver security file-directory ntfs dacl add -vserver cats-svm -ntfs-sd ADMIN_SD -access-type allow -account 'BUILTIN\Administrators' -rights full-control"
  register: add_admin_result
  ignore_errors: yes
  delegate_to: localhost
  tags: [netapp_perms]

- name: "Créer politique simple"
  shell: |
    sshpass -p "n7O3DkkuCz711WCA" ssh -o StrictHostKeyChecking=no fsxadmin@10.105.57.94 \
    "vserver security file-directory policy create -vserver cats-svm -policy-name ADMIN_policy"
  register: create_policy_result
  ignore_errors: yes
  delegate_to: localhost
  tags: [netapp_perms]

- name: "Ajouter tâche pour /FSHQ"
  shell: |
    sshpass -p "n7O3DkkuCz711WCA" ssh -o StrictHostKeyChecking=no fsxadmin@10.105.57.94 \
    "vserver security file-directory policy task add -vserver cats-svm -policy-name ADMIN_policy -path /FSHQ -security-type ntfs -ntfs-sd ADMIN_SD -ntfs-mode propagate"
  register: add_task_result
  ignore_errors: yes
  delegate_to: localhost
  tags: [netapp_perms]

- name: "Appliquer les permissions"
  shell: |
    sshpass -p "n7O3DkkuCz711WCA" ssh -o StrictHostKeyChecking=no fsxadmin@10.105.57.94 \
    "vserver security file-directory apply -vserver cats-svm -policy-name ADMIN_policy"
  register: apply_result
  ignore_errors: yes
  delegate_to: localhost
  tags: [netapp_perms]

- name: "Debug simple"
  debug:
    msg: |
      SD créé: {{ create_sd_result.rc == 0 }}
      Admin ajouté: {{ add_admin_result.rc == 0 }}
      Politique: {{ create_policy_result.rc == 0 }}
      Appliqué: {{ apply_result.rc == 0 }}
  tags: [netapp_perms]
