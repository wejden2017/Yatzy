def get_ec2_instances(tag_key, tag_value, region):
    ec2 = boto3.client('ec2', region_name=region)
    response = ec2.describe_instances(
        Filters=[
            {'Name': f'tag:{tag_key}', 'Values': [tag_value]},
            {'Name': 'instance-state-name', 'Values': ['running']}
        ]
    )

    instances = []
    for reservation in response['Reservations']:
        for instance in reservation['Instances']:
            public_dns_tag = next(
                (tag['Value'] for tag in instance.get('Tags', []) if tag['Key'] == 'PublicDnsName'),
                None
            )

            # üîç Chercher VPC ID √† deux endroits possibles
            vpc_id_value = instance.get('VpcId')
            if not vpc_id_value and 'NetworkInterfaces' in instance:
                for ni in instance['NetworkInterfaces']:
                    if 'VpcId' in ni:
                        vpc_id_value = ni['VpcId']
                        break

            instances.append({
                'private_ip': instance.get('PrivateIpAddress', 'N/A'),
                'instance_id': instance.get('InstanceId', 'N/A'),
                'PublicDnsName': public_dns_tag,
                'vpc_id': vpc_id_value or 'vpc-UNKNOWN'
            })
    return instances
