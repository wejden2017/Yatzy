# Horodatage lisible
- name: Compute readable timestamp
  set_fact:
    log_timestamp: "{{ ansible_date_time.date | regex_replace('-', '') }}{{ ansible_date_time.time | regex_replace(':', '') }}"
  when: ansible_date_time is defined
  tags: [update_database]

# Fallback si ansible_date_time absent → CI pipeline ID → sinon epoch
- name: Fallback timestamp if ansible_date_time missing
  set_fact:
    log_timestamp: >-
      {{ lookup('env','CI_PIPELINE_ID')
         | default(lookup('pipe','date +%Y%m%d%H%M%S')) }}
  when: log_timestamp is not defined
  tags: [update_database]
