#!/bin/ksh

. ${HOME}/env/env.ksh
. ${CATS_OPER}/common_functions.sh

LOG_SCRIPT=${CATS_LOG}/`basename $0 ".ksh"`.log
nom_script=`basename $0 "@@"`
exec 1>>"$LOG_SCRIPT" 2>>"$LOG_SCRIPT"

LOGINFO "${nom_script}" "Début" | tee -a "$LOG_GENERAL"
LOGSTART "${nom_script}"

SCRIPT_CALYPSO="${SHELL_REP}/CALYPSO_integration_csv.ksh"
LOGINFO "${nom_script}" "DATA_APF=${DATA_APF}"
LOGINFO "${nom_script}" "SCRIPT_CALYPSO=${SCRIPT_CALYPSO}"

found=0
for file in "${DATA_APF}"/CAL_TO_CAT_*.[cC][sS][vV]
do
  [ -e "$file" ] || continue
  found=1
  LOGINFO "${nom_script}" "Détection fichier : $file"
  fname="$(basename "$file")"
  "${SCRIPT_CALYPSO}" "$fname"
  rc=$?
  if [ $rc -eq 0 ]; then
    mv "$file" "${file}_traite"
    LOGINFO "${nom_script}" "Succès traitement (rc=$rc) : renommé en ${file}_traite"
  else
    LOGERR "${nom_script}" "Traitement KO (rc=$rc) pour $file → pas de renommage"
  fi
done

if [ $found -eq 0 ]; then
  LOGERR "${nom_script}" "Aucun fichier trouvé dans ${DATA_APF} avec le pattern CAL_TO_CAT_*.[cC][sS][vV]"
fi

LOGEND "${nom_script}" "Fin" | tee -a "$LOG_GENERAL"
exit 0
