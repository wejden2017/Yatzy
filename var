-- ============================================================================
-- √âTAPE 1 : TRIGGER DE S√âCURIT√â
-- Connexion: SYS as SYSDBA
-- ============================================================================

CONNECT sys/password@VOTRE_TNS AS SYSDBA

-- Cr√©er le trigger qui autorise DROP uniquement sur LUCA
CREATE OR REPLACE TRIGGER SYS.TRG_BLOCK_DROP_EXCEPT_LUCA
BEFORE DROP ON DATABASE
DECLARE
    v_schema      VARCHAR2(128);
    v_object_name VARCHAR2(128);
    v_object_type VARCHAR2(50);
    v_username    VARCHAR2(128);
BEGIN
    v_schema      := ORA_DICT_OBJ_OWNER;
    v_object_name := ORA_DICT_OBJ_NAME;
    v_object_type := ORA_DICT_OBJ_TYPE;
    v_username    := ORA_LOGIN_USER;
    
    -- Autoriser DROP uniquement sur le sch√©ma LUCA
    -- Exceptions: SYS et SYSTEM peuvent tout faire
    IF v_username NOT IN ('SYS', 'SYSTEM') AND v_schema != 'LUCA' THEN
        RAISE_APPLICATION_ERROR(-20001,
            '‚õî S√âCURIT√â : DROP interdit sur le sch√©ma ' || v_schema || '. ' ||
            'Vous ne pouvez DROP que sur LUCA. ' ||
            '(User: ' || v_username || ', Objet: ' || v_object_type || ' ' || v_object_name || ')');
    END IF;
    
    -- Si le sch√©ma est LUCA, autoriser l'op√©ration
    NULL;
    
EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END;
/

-- ‚úÖ VALIDATION √âTAPE 1
SELECT trigger_name, status, trigger_type 
FROM dba_triggers 
WHERE trigger_name = 'TRG_BLOCK_DROP_EXCEPT_LUCA';

-- R√©sultat attendu: 1 ligne avec STATUS = 'ENABLED'


etape 2 :

CREATE ROLE QA_ROLE_ZOI;

-- Privil√®ges de connexion
GRANT CREATE SESSION TO QA_ROLE_ZOI;
GRANT CONNECT TO QA_ROLE_ZOI;
GRANT RESOURCE TO QA_ROLE_ZOI;

-- Privil√®ges de cr√©ation d'objets (dans leur propre sch√©ma)
GRANT CREATE TABLE TO QA_ROLE_ZOI;
GRANT CREATE VIEW TO QA_ROLE_ZOI;
GRANT CREATE PROCEDURE TO QA_ROLE_ZOI;
GRANT CREATE SEQUENCE TO QA_ROLE_ZOI;
GRANT CREATE SYNONYM TO QA_ROLE_ZOI;
GRANT CREATE TRIGGER TO QA_ROLE_ZOI;
GRANT CREATE TYPE TO QA_ROLE_ZOI;
GRANT CREATE MATERIALIZED VIEW TO QA_ROLE_ZOI;
GRANT CREATE DATABASE LINK TO QA_ROLE_ZOI;

-- ‚≠ê PRIVIL√àGES DDL (prot√©g√©s par le trigger cr√©√© √† l'√©tape 1)
GRANT ALTER ANY TABLE TO QA_ROLE_ZOI;
GRANT DROP ANY TABLE TO QA_ROLE_ZOI;
GRANT ALTER ANY PROCEDURE TO QA_ROLE_ZOI;
GRANT DROP ANY PROCEDURE TO QA_ROLE_ZOI;
GRANT ALTER ANY SEQUENCE TO QA_ROLE_ZOI;
GRANT DROP ANY SEQUENCE TO QA_ROLE_ZOI;
GRANT DROP ANY VIEW TO QA_ROLE_ZOI;
GRANT DROP ANY TYPE TO QA_ROLE_ZOI;
GRANT DROP ANY MATERIALIZED VIEW TO QA_ROLE_ZOI;
GRANT DROP ANY TRIGGER TO QA_ROLE_ZOI;
GRANT TRUNCATE ANY TABLE TO QA_ROLE_ZOI;

-- Privil√®ges de consultation du dictionnaire
GRANT SELECT_CATALOG_ROLE TO QA_ROLE_ZOI;
GRANT SELECT ANY DICTIONARY TO QA_ROLE_ZOI;
GRANT ANALYZE ANY TO QA_ROLE_ZOI;

-- Acc√®s aux vues dynamiques V$
GRANT SELECT ON V_$SESSION TO QA_ROLE_ZOI;
GRANT SELECT ON V_$SQL TO QA_ROLE_ZOI;
GRANT SELECT ON V_$SQL_PLAN TO QA_ROLE_ZOI;
GRANT SELECT ON V_$SQLAREA TO QA_ROLE_ZOI;
GRANT SELECT ON V_$PARAMETER TO QA_ROLE_ZOI;



CREATE OR REPLACE PROCEDURE LUCA.GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA(
    p_schema_name VARCHAR2 DEFAULT 'LUCA',
    p_role_name   VARCHAR2 DEFAULT 'QA_ROLE_ZOI'
) AS
    v_sql VARCHAR2(4000);
BEGIN
    DBMS_OUTPUT.PUT_LINE('========================================');
    DBMS_OUTPUT.PUT_LINE('D√©but des GRANT pour ' || p_role_name || ' sur sch√©ma ' || p_schema_name);
    DBMS_OUTPUT.PUT_LINE('========================================');
    
    -- ===== TABLES =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- TABLES ---');
    FOR rec IN (SELECT table_name FROM all_tables WHERE owner = UPPER(p_schema_name)) LOOP
        BEGIN
            v_sql := 'GRANT ALL PRIVILEGES ON ' || p_schema_name || '.' || rec.table_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì Table: ' || rec.table_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('‚úó Erreur table ' || rec.table_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    -- ===== VUES =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- VUES ---');
    FOR rec IN (SELECT view_name FROM all_views WHERE owner = UPPER(p_schema_name)) LOOP
        BEGIN
            v_sql := 'GRANT SELECT ON ' || p_schema_name || '.' || rec.view_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì Vue: ' || rec.view_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('‚úó Erreur vue ' || rec.view_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    -- ===== SEQUENCES =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- SEQUENCES ---');
    FOR rec IN (SELECT sequence_name FROM all_sequences WHERE sequence_owner = UPPER(p_schema_name)) LOOP
        BEGIN
            v_sql := 'GRANT SELECT, ALTER ON ' || p_schema_name || '.' || rec.sequence_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì Sequence: ' || rec.sequence_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('‚úó Erreur sequence ' || rec.sequence_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    -- ===== PROCEDURES, FUNCTIONS, PACKAGES, TYPES =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- PROCEDURES/FUNCTIONS/PACKAGES/TYPES ---');
    FOR rec IN (SELECT object_name, object_type FROM all_objects
                WHERE owner = UPPER(p_schema_name)
                  AND object_type IN ('PROCEDURE', 'FUNCTION', 'PACKAGE', 'TYPE')) LOOP
        BEGIN
            v_sql := 'GRANT EXECUTE ON ' || p_schema_name || '.' || rec.object_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì ' || rec.object_type || ': ' || rec.object_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('‚úó Erreur ' || rec.object_type || ' ' || rec.object_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    -- ===== MATERIALIZED VIEWS =====
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('--- MATERIALIZED VIEWS ---');
    FOR rec IN (SELECT mview_name FROM all_mviews WHERE owner = UPPER(p_schema_name)) LOOP
        BEGIN
            v_sql := 'GRANT SELECT ON ' || p_schema_name || '.' || rec.mview_name || ' TO ' || p_role_name;
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì MView: ' || rec.mview_name);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('‚úó Erreur mview ' || rec.mview_name || ': ' || SQLERRM);
        END;
    END LOOP;
    
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('========================================');
    DBMS_OUTPUT.PUT_LINE('‚úÖ Privil√®ges accord√©s avec succ√®s sur le sch√©ma ' || p_schema_name);
    DBMS_OUTPUT.PUT_LINE('========================================');
    
END GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA;
/

-- ‚úÖ VALIDATION √âTAPE 3
SELECT object_name, object_type, status 
FROM user_objects 
WHERE object_name = 'GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA';
-- R√©sultat attendu: 1 ligne avec STATUS = 'VALID'

√âTAPE 4 : Cr√©er le user ZOUERTANI et lui affecter le r√¥le
√Ä ex√©cuter en tant que : SYS ou SYSDBA
sql-- ============================================================================
-- √âTAPE 4 : CR√âATION DU USER ZOUERTANI
-- Connexion: SYS as SYSDBA
-- ============================================================================

CONNECT sys/password@VOTRE_TNS AS SYSDBA

-- Cr√©er le user
CREATE USER zouertani 
IDENTIFIED BY "MotDePasse123!" 
DEFAULT TABLESPACE USERS 
TEMPORARY TABLESPACE TEMP
QUOTA UNLIMITED ON USERS;

-- Affecter le r√¥le
GRANT QA_ROLE_ZOI TO zouertani;

-- R√¥le par d√©faut
ALTER USER zouertani DEFAULT ROLE QA_ROLE_ZOI;

-- ‚úÖ VALIDATION √âTAPE 4
SELECT username, account_status, default_tablespace 
FROM dba_users 
WHERE username = 'ZOUERTANI';
-- R√©sultat attendu: 1 ligne avec ACCOUNT_STATUS = 'OPEN'

SELECT grantee, granted_role 
FROM dba_role_privs 
WHERE grantee = 'ZOUERTANI';
-- R√©sultat attendu: 1 ligne avec GRANTED_ROLE = 'QA_ROLE_ZOI'

√âTAPE 5 : Ex√©cuter la proc√©dure pour donner les grants sur objets existants
√Ä ex√©cuter en tant que : LUCA
sql-- ============================================================================
-- √âTAPE 5 : EX√âCUTION DE LA PROC√âDURE DE GRANT
-- Connexion: LUCA
-- ============================================================================

CONNECT luca/password@VOTRE_TNS

SET SERVEROUTPUT ON SIZE UNLIMITED

-- Ex√©cuter la proc√©dure
EXEC LUCA.GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA('LUCA', 'QA_ROLE_ZOI');

-- ‚úÖ VALIDATION √âTAPE 5
-- V√©rifier que le r√¥le a bien les privil√®ges sur les objets de LUCA
SELECT table_name, privilege 
FROM dba_tab_privs 
WHERE grantee = 'QA_ROLE_ZOI' AND owner = 'LUCA'
ORDER BY table_name, privilege;
-- R√©sultat attendu: Liste des objets avec leurs privil√®ges

√âTAPE 6 : TESTS COMPLETS
Test 6A : Cr√©er une table de test avec LUCA
sql-- ============================================================================
-- TEST 6A : CR√âATION TABLE AVEC LUCA
-- Connexion: LUCA
-- ============================================================================

CONNECT luca/password@VOTRE_TNS

-- Cr√©er une table de test
CREATE TABLE LUCA.TEST_DROP_TABLE (
    id NUMBER PRIMARY KEY,
    nom VARCHAR2(100),
    date_creation DATE DEFAULT SYSDATE
);

-- Ins√©rer des donn√©es
INSERT INTO LUCA.TEST_DROP_TABLE VALUES (1, 'Test 1', SYSDATE);
INSERT INTO LUCA.TEST_DROP_TABLE VALUES (2, 'Test 2', SYSDATE);
COMMIT;

-- ‚úÖ VALIDATION 6A
SELECT * FROM LUCA.TEST_DROP_TABLE;
-- R√©sultat attendu: 2 lignes
Test 6B : V√©rifier que ZOUERTANI peut voir la table
sql-- ============================================================================
-- TEST 6B : SELECT AVEC ZOUERTANI
-- Connexion: ZOUERTANI
-- ============================================================================

CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- ‚ö†Ô∏è IMPORTANT : La table vient d'√™tre cr√©√©e, elle n'aura pas les grants automatiques
-- car on n'a pas encore cr√©√© le trigger DDL !
-- Pour ce test, on doit ex√©cuter manuellement le grant

-- Retourner en LUCA pour donner les grants
CONNECT luca/password@VOTRE_TNS

GRANT ALL PRIVILEGES ON LUCA.TEST_DROP_TABLE TO QA_ROLE_ZOI;

-- Revenir en ZOUERTANI
CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- ‚úÖ VALIDATION 6B
SELECT * FROM LUCA.TEST_DROP_TABLE;
-- R√©sultat attendu: 2 lignes

-- Test INSERT
INSERT INTO LUCA.TEST_DROP_TABLE VALUES (3, 'Test par ZOUERTANI', SYSDATE);
COMMIT;

SELECT * FROM LUCA.TEST_DROP_TABLE;
-- R√©sultat attendu: 3 lignes
Test 6C : Modifier la structure de la table (ALTER)
sql-- ============================================================================
-- TEST 6C : ALTER TABLE AVEC ZOUERTANI
-- Connexion: ZOUERTANI
-- ============================================================================

CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- Ajouter une colonne
ALTER TABLE LUCA.TEST_DROP_TABLE ADD (email VARCHAR2(100));

-- ‚úÖ VALIDATION 6C
DESC LUCA.TEST_DROP_TABLE
-- R√©sultat attendu: La colonne 'email' doit appara√Ætre

-- Test UPDATE
UPDATE LUCA.TEST_DROP_TABLE SET email = 'test@example.com' WHERE id = 1;
COMMIT;

SELECT * FROM LUCA.TEST_DROP_TABLE WHERE id = 1;
-- R√©sultat attendu: email = 'test@example.com'
Test 6D : Supprimer la table (DROP) - LE TEST CRUCIAL
sql-- ============================================================================
-- TEST 6D : DROP TABLE SUR LUCA (DOIT R√âUSSIR)
-- Connexion: ZOUERTANI
-- ============================================================================

CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- Tenter de DROP la table de LUCA - DOIT R√âUSSIR
DROP TABLE LUCA.TEST_DROP_TABLE PURGE;

-- ‚úÖ VALIDATION 6D
SELECT table_name FROM all_tables WHERE owner = 'LUCA' AND table_name = 'TEST_DROP_TABLE';
-- R√©sultat attendu: Aucune ligne (la table est supprim√©e)

DBMS_OUTPUT.PUT_LINE('‚úÖ TEST R√âUSSI : DROP sur LUCA autoris√©');
Test 6E : Tenter de DROP une table SYS (DOIT √äTRE BLOQU√â)
sql-- ============================================================================
-- TEST 6E : DROP TABLE SUR SYS (DOIT √äTRE BLOQU√â PAR LE TRIGGER)
-- Connexion: ZOUERTANI
-- ============================================================================

CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- Cr√©er d'abord une petite table de test dans le sch√©ma SYSTEM pour le test
-- (On ne peut pas cr√©er dans SYS, donc on va tester avec SYSTEM)

-- En tant que SYS, cr√©er une table de test dans SYSTEM
CONNECT sys/password@VOTRE_TNS AS SYSDBA

CREATE TABLE SYSTEM.TEST_PROTECTION (id NUMBER);

-- Retourner en ZOUERTANI
CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- Tenter de DROP cette table - DOIT √äTRE BLOQU√â
DROP TABLE SYSTEM.TEST_PROTECTION;

-- ‚ùå R√âSULTAT ATTENDU : 
-- ORA-20001: ‚õî S√âCURIT√â : DROP interdit sur le sch√©ma SYSTEM. 
-- Vous ne pouvez DROP que sur LUCA. (User: ZOUERTANI, Objet: TABLE TEST_PROTECTION)

-- Si vous voyez cette erreur, LE TEST EST R√âUSSI ! ‚úÖ

-- Nettoyer en tant que SYS
CONNECT sys/password@VOTRE_TNS AS SYSDBA
DROP TABLE SYSTEM.TEST_PROTECTION PURGE;

√âTAPE 7 : Cr√©er le trigger DDL pour auto-grant sur nouveaux objets
√Ä ex√©cuter en tant que : LUCA
sql-- ============================================================================
-- √âTAPE 7 : TRIGGER DDL AUTO-GRANT
-- Connexion: LUCA
-- ============================================================================

CONNECT luca/password@VOTRE_TNS

CREATE OR REPLACE TRIGGER LUCA.TRG_AUTO_GRANT_QA_ON_CREATE
AFTER CREATE ON LUCA.SCHEMA
DECLARE
    v_obj_type VARCHAR2(50);
    v_obj_name VARCHAR2(128);
    v_sql      VARCHAR2(4000);
BEGIN
    v_obj_type := ORA_DICT_OBJ_TYPE;
    v_obj_name := ORA_DICT_OBJ_NAME;
    
    DBMS_OUTPUT.PUT_LINE('üîî Nouvel objet cr√©√©: ' || v_obj_type || ' ' || v_obj_name);
    
    CASE v_obj_type
        
        -- TABLES : ALL PRIVILEGES
        WHEN 'TABLE' THEN
            v_sql := 'GRANT ALL PRIVILEGES ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT ALL PRIVILEGES sur table ' || v_obj_name);
            
        -- VUES : SELECT
        WHEN 'VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT SELECT sur vue ' || v_obj_name);
            
        -- MATERIALIZED VIEWS
        WHEN 'MATERIALIZED VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT SELECT sur mview ' || v_obj_name);
            
        -- SEQUENCES
        WHEN 'SEQUENCE' THEN
            v_sql := 'GRANT SELECT, ALTER ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT SELECT, ALTER sur sequence ' || v_obj_name);
            
        -- PROCEDURES/FUNCTIONS/PACKAGES/TYPES
        WHEN 'PROCEDURE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT EXECUTE sur procedure ' || v_obj_name);
            
        WHEN 'FUNCTION' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT EXECUTE sur function ' || v_obj_name);
            
        WHEN 'PACKAGE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT EXECUTE sur package ' || v_obj_name);
            
        WHEN 'TYPE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT EXECUTE sur type ' || v_obj_name);
            
        ELSE
            DBMS_OUTPUT.PUT_LINE('‚Ñπ Type ' || v_obj_type || ' ignor√©');
    END CASE;
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('‚úó Erreur auto-grant sur ' || v_obj_name || ': ' || SQLERRM);
        NULL; -- Ne pas bloquer la cr√©ation de l'objet
END;
/

-- ‚úÖ VALIDATION √âTAPE 7
SELECT trigger_name, status, trigger_type 
FROM user_triggers 
WHERE trigger_name = 'TRG_AUTO_GRANT_QA_ON_CREATE';
-- R√©sultat attendu: 1 ligne avec STATUS = 'ENABLED'

√âTAPE 8 : Test du trigger DDL auto-grant
sql-- ============================================================================
-- TEST 8 : TRIGGER DDL AUTO-GRANT
-- ============================================================================

-- En tant que LUCA, cr√©er une nouvelle table
CONNECT luca/password@VOTRE_TNS

SET SERVEROUTPUT ON SIZE UNLIMITED

CREATE TABLE LUCA.TEST_AUTO_GRANT (
    id NUMBER PRIMARY KEY,
    description VARCHAR2(200)
);

-- Le trigger devrait afficher:
-- üîî Nouvel objet cr√©√©: TABLE TEST_AUTO_GRANT
-- ‚úì GRANT ALL PRIVILEGES sur table TEST_AUTO_GRANT

-- En tant que ZOUERTANI, v√©rifier l'acc√®s imm√©diat
CONNECT zouertani/MotDePasse123!@VOTRE_TNS

-- ‚úÖ VALIDATION 8A : SELECT doit fonctionner imm√©diatement
SELECT * FROM LUCA.TEST_AUTO_GRANT;
-- R√©sultat attendu: 0 lignes (table vide mais accessible)

-- ‚úÖ VALIDATION 8B : INSERT doit fonctionner
INSERT INTO LUCA.TEST_AUTO_GRANT VALUES (1, 'Test auto-grant');
COMMIT;

-- ‚úÖ VALIDATION 8C : UPDATE doit fonctionner
UPDATE LUCA.TEST_AUTO_GRANT SET description = 'Modifi√©' WHERE id = 1;
COMMIT;

-- ‚úÖ VALIDATION 8D : DELETE doit fonctionner
DELETE FROM LUCA.TEST_AUTO_GRANT WHERE id = 1;
COMMIT;

-- ‚úÖ VALIDATION 8E : ALTER doit fonctionner
ALTER TABLE LUCA.TEST_AUTO_GRANT ADD (date_creation DATE);

-- ‚úÖ VALIDATION 8F : DROP doit fonctionner
DROP TABLE LUCA.TEST_AUTO_GRANT PURGE;

DBMS_OUTPUT.PUT_LINE('‚úÖ TOUS LES TESTS AUTO-GRANT R√âUSSIS !');

üìã CHECKLIST FINALE AVANT ANSIBLE
V√©rifiez que tous ces tests sont ‚úÖ :
sql-- ============================================================================
-- CHECKLIST FINALE
-- ============================================================================

-- 1. Trigger de s√©curit√© existe et est activ√©
SELECT trigger_name, status FROM dba_triggers 
WHERE trigger_name = 'TRG_BLOCK_DROP_EXCEPT_LUCA';
-- ‚úÖ Attendu: 1 ligne, STATUS = 'ENABLED'

-- 2. R√¥le QA_ROLE_ZOI existe
SELECT role FROM dba_roles WHERE role = 'QA_ROLE_ZOI';
-- ‚úÖ Attendu: 1 ligne

-- 3. R√¥le a les privil√®ges DROP ANY TABLE
SELECT privilege FROM dba_sys_privs 
WHERE grantee = 'QA_ROLE_ZOI' AND privilege LIKE '%DROP%';
-- ‚úÖ Attendu: Plusieurs lignes dont 'DROP ANY TABLE'

-- 4. User ZOUERTANI existe et a le r√¥le
SELECT username, account_status FROM dba_users WHERE username = 'ZOUERTANI';
SELECT grantee, granted_role FROM dba_role_privs WHERE grantee = 'ZOUERTANI';
-- ‚úÖ Attendu: ZOUERTANI avec r√¥le QA_ROLE_ZOI

-- 5. Proc√©dure GRANT existe et est valide
SELECT object_name, status FROM dba_objects 
WHERE owner = 'LUCA' AND object_name = 'GRANT_QA_ROLE_ZOI_ACCESS_TO_SCHEMA';
-- ‚úÖ Attendu: STATUS = 'VALID'

-- 6. Trigger DDL existe et est activ√©
SELECT trigger_name, status FROM dba_triggers 
WHERE owner = 'LUCA' AND trigger_name = 'TRG_AUTO_GRANT_QA_ON_CREATE';
-- ‚úÖ Attendu: STATUS = 'ENABLED'

-- 7. Test DROP sur LUCA r√©ussit
-- 8. Test DROP sur SYS/SYSTEM √©choue avec ORA-20001
-- 9. Test auto-grant sur nouveau objet r√©ussit

üöÄ SI TOUS LES TESTS SONT ‚úÖ, VOUS POUVEZ PASSER √Ä ANSIBLE !
R√©sum√© de ce qui fonctionne maintenant :

‚úÖ ZOUERTANI peut SELECT, INSERT, UPDATE, DELETE sur les tables de LUCA
‚úÖ ZOUERTANI peut ALTER les tables de LUCA
‚úÖ ZOUERTANI peut DROP les tables de LUCA
‚úÖ ZOUERTANI NE PEUT PAS DROP les tables de SYS/SYSTEM (bloqu√© par trigger)
‚úÖ Les nouveaux objets cr√©√©s par LUCA re√ßoivent automatiquement les grants

SELECT line, position, text
FROM dba_errors
WHERE owner = 'SYS' 
  AND name = 'TRG_BLOCK_DROP_EXCEPT_LUCA'
ORDER BY sequence;

-- ============================================================================
-- TRIGGER CORRIG√â - Version sans / √† l'int√©rieur
-- √Ä ex√©cuter en tant que: SYS as SYSDBA
-- ============================================================================

CONNECT sys/password@VOTRE_TNS AS SYSDBA

-- Supprimer l'ancien trigger invalide
DROP TRIGGER SYS.TRG_BLOCK_DROP_EXCEPT_LUCA;

-- Cr√©er le trigger corrig√© (ATTENTION: pas de / dans le code)
CREATE OR REPLACE TRIGGER SYS.TRG_BLOCK_DROP_EXCEPT_LUCA
BEFORE DROP ON DATABASE
DECLARE
    v_schema      VARCHAR2(128);
    v_username    VARCHAR2(128);
    v_object_name VARCHAR2(128);
    v_object_type VARCHAR2(50);
BEGIN
    v_schema      := SYS.DICTIONARY_OBJ_OWNER;
    v_username    := SYS.LOGIN_USER;
    v_object_name := SYS.DICTIONARY_OBJ_NAME;
    v_object_type := SYS.DICTIONARY_OBJ_TYPE;
    
    IF v_username IN ('SYS', 'SYSTEM') THEN
        RETURN;
    END IF;
    
    IF v_schema != 'LUCA' THEN
        RAISE_APPLICATION_ERROR(-20001,
            'SECURITE: DROP interdit sur le schema ' || v_schema || '. ' ||
            'Vous ne pouvez DROP que sur LUCA. ' ||
            '(User: ' || v_username || ', Objet: ' || v_object_type || ' ' || v_object_name || ')');
    END IF;
    
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -20001 THEN
            RAISE;
        ELSE
            NULL;
        END IF;
END TRG_BLOCK_DROP_EXCEPT_LUCA;



üîß SOLUTION : Utiliser PRAGMA AUTONOMOUS_TRANSACTION
Le trigger doit s'ex√©cuter dans une transaction autonome pour pouvoir faire des GRANT.
Voici le trigger corrig√© :
sql-- ============================================================================
-- TRIGGER AUTO-GRANT CORRIG√â avec AUTONOMOUS_TRANSACTION
-- √Ä ex√©cuter en tant que: LUCA
-- ============================================================================

CONNECT luca/password@VOTRE_TNS

-- Supprimer l'ancien trigger
DROP TRIGGER LUCA.TRG_AUTO_GRANT_QA_ON_CREATE;

-- Cr√©er le trigger avec transaction autonome
CREATE OR REPLACE TRIGGER LUCA.TRG_AUTO_GRANT_QA_ON_CREATE
AFTER CREATE ON LUCA.SCHEMA
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;  -- ‚≠ê CRUCIAL !
    
    v_obj_type VARCHAR2(50);
    v_obj_name VARCHAR2(128);
    v_sql      VARCHAR2(4000);
BEGIN
    v_obj_type := ORA_DICT_OBJ_TYPE;
    v_obj_name := ORA_DICT_OBJ_NAME;
    
    DBMS_OUTPUT.PUT_LINE('üîî Nouvel objet cr√©√©: ' || v_obj_type || ' ' || v_obj_name);
    
    CASE v_obj_type
        
        WHEN 'TABLE' THEN
            v_sql := 'GRANT ALL PRIVILEGES ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT ALL PRIVILEGES sur table ' || v_obj_name);
            
        WHEN 'VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT SELECT sur vue ' || v_obj_name);
            
        WHEN 'MATERIALIZED VIEW' THEN
            v_sql := 'GRANT SELECT ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT SELECT sur mview ' || v_obj_name);
            
        WHEN 'SEQUENCE' THEN
            v_sql := 'GRANT SELECT, ALTER ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT SELECT, ALTER sur sequence ' || v_obj_name);
            
        WHEN 'PROCEDURE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT EXECUTE sur procedure ' || v_obj_name);
            
        WHEN 'FUNCTION' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT EXECUTE sur function ' || v_obj_name);
            
        WHEN 'PACKAGE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT EXECUTE sur package ' || v_obj_name);
            
        WHEN 'TYPE' THEN
            v_sql := 'GRANT EXECUTE ON LUCA.' || v_obj_name || ' TO QA_ROLE_ZOI';
            EXECUTE IMMEDIATE v_sql;
            DBMS_OUTPUT.PUT_LINE('‚úì GRANT EXECUTE sur type ' || v_obj_name);
            
        ELSE
            DBMS_OUTPUT.PUT_LINE('‚Ñπ Type ' || v_obj_type || ' ignor√©');
    END CASE;
    
    COMMIT;  -- ‚≠ê IMPORTANT : Commiter la transaction autonome
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('‚úó Erreur auto-grant sur ' || v_obj_name || ': ' || SQLERRM);
        ROLLBACK;  -- Rollback en cas d'erreur
        -- Ne pas propager l'erreur pour ne pas bloquer la cr√©ation de l'objet
END TRG_AUTO_GRANT_QA_ON_CREATE;
/

-- ‚úÖ V√âRIFIER
SELECT trigger_name, status 
FROM user_triggers 
WHERE trigger_name = 'TRG_AUTO_GRANT_QA_ON_CREATE';
-- R√©sultat attendu: STATUS = 'ENABLED'

