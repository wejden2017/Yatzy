- name: Ensure log file exists (tolerant)
  ansible.builtin.shell: |
    set -e
    test -f "{{ tar_deploy_path }}/install_dba_scripts_aws.log" && stat -c '%s' "{{ tar_deploy_path }}/install_dba_scripts_aws.log" || true
  changed_when: false

# Rapatrier le log du remote vers le workspace GitLab (répertoire local du job)
- name: Fetch Oracle update log to artifacts folder
  ansible.builtin.fetch:
    src: "{{ tar_deploy_path }}/install_dba_scripts_aws.log"
    dest: "artifacts/{{ inventory_hostname }}-install_dba_scripts_aws.log"
    flat: true
  become: true
  failed_when: false   # on veut des artifacts même si le script a échoué


artifacts:
  when: always           # garder les logs même si le job échoue
  expire_in: 14 days
  paths:
    - artifacts/*.log


- name: Tail Oracle update log on failure
  ansible.builtin.shell: |
    set -e
    tail -n 200 "{{ tar_deploy_path }}/install_dba_scripts_aws.log" || true
  when: oracle_update_result is defined and oracle_update_result.rc != 0
  changed_when: false
