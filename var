sql-- V√©rifier que le r√¥le existe
SELECT role 
FROM dba_roles 
WHERE role = 'QA_ROLE';

-- R√©sultat attendu :
-- ROLE
-- -------
-- QA_ROLE

‚úÖ 2. V√©rifier les privil√®ges du r√¥le QA_ROLE
sql-- Privil√®ges syst√®me
SELECT privilege 
FROM dba_sys_privs 
WHERE grantee = 'QA_ROLE' 
ORDER BY privilege;

-- R√©sultat attendu : ~15 privil√®ges
-- CREATE SESSION
-- CONNECT
-- RESOURCE
-- CREATE TABLE
-- CREATE VIEW
-- etc.
sql-- Privil√®ges sur les vues V$
SELECT owner, table_name, privilege 
FROM dba_tab_privs 
WHERE grantee = 'QA_ROLE' 
ORDER BY table_name;

-- R√©sultat attendu :
-- OWNER  TABLE_NAME    PRIVILEGE
-- SYS    V_$SESSION    SELECT
-- SYS    V_$SQL        SELECT
-- etc.

‚úÖ 3. V√©rifier la proc√©dure GRANT_ACCESS_TO_SCHEMA
sql-- V√©rifier que la proc√©dure existe
SELECT object_name, object_type, status 
FROM dba_objects 
WHERE object_name = 'GRANT_QA_ROLE_ACCESS_TO_SCHEMA'
  AND owner = 'SYS';

-- R√©sultat attendu :
-- OBJECT_NAME                        OBJECT_TYPE  STATUS
-- GRANT_QA_ROLE_ACCESS_TO_SCHEMA    PROCEDURE    VALID
sql-- Voir le code source de la proc√©dure
SELECT text 
FROM dba_source 
WHERE name = 'GRANT_QA_ROLE_ACCESS_TO_SCHEMA' 
  AND owner = 'SYS'
ORDER BY line;

‚úÖ 4. V√©rifier les triggers DDL AUTO_GRANT
sql-- Lister tous les triggers AUTO_GRANT
SELECT trigger_name, status, table_owner, triggering_event 
FROM dba_triggers 
WHERE trigger_name LIKE 'AUTO_GRANT%' 
ORDER BY trigger_name;

-- R√©sultat attendu :
-- TRIGGER_NAME                      STATUS   TABLE_OWNER  TRIGGERING_EVENT
-- AUTO_GRANT_LUCA_TO_QA_ROLE       ENABLED  LUCA         CREATE
sql-- D√©tail d'un trigger sp√©cifique
SELECT trigger_name, status, trigger_type, triggering_event, table_owner 
FROM dba_triggers 
WHERE trigger_name = 'AUTO_GRANT_LUCA_TO_QA_ROLE';
sql-- Voir le code source d'un trigger
SELECT trigger_body 
FROM dba_triggers 
WHERE trigger_name = 'AUTO_GRANT_LUCA_TO_QA_ROLE';

‚úÖ 5. V√©rifier les utilisateurs cr√©√©s
sql-- V√©rifier que l'utilisateur userqalch existe
SELECT username, account_status, default_tablespace, created 
FROM dba_users 
WHERE username = 'USERQALCH';

-- R√©sultat attendu :
-- USERNAME    ACCOUNT_STATUS  DEFAULT_TABLESPACE  CREATED
-- USERQALCH   OPEN            CATS_DATA           02-DEC-24
sql-- V√©rifier que l'utilisateur a le r√¥le QA_ROLE
SELECT grantee, granted_role, default_role 
FROM dba_role_privs 
WHERE grantee = 'USERQALCH';

-- R√©sultat attendu :
-- GRANTEE    GRANTED_ROLE  DEFAULT_ROLE
-- USERQALCH  QA_ROLE       YES

‚úÖ 6. V√©rifier les privil√®ges sur le sch√©ma LUCA
sql-- V√©rifier que QA_ROLE a des privil√®ges sur les objets de LUCA
SELECT owner, table_name, privilege 
FROM dba_tab_privs 
WHERE grantee = 'QA_ROLE' 
  AND owner = 'LUCA'
ORDER BY table_name;

-- Devrait afficher toutes les tables/vues/s√©quences de LUCA avec leurs privil√®ges

üß™ 7. Test complet - V√©rifier que tout fonctionne ensemble
sql-- Requ√™te compl√®te de v√©rification
SELECT 
    'Role' AS object_type,
    role AS object_name,
    NULL AS status
FROM dba_roles 
WHERE role = 'QA_ROLE'

UNION ALL

SELECT 
    'Procedure' AS object_type,
    object_name,
    status
FROM dba_objects 
WHERE object_name = 'GRANT_QA_ROLE_ACCESS_TO_SCHEMA'
  AND owner = 'SYS'

UNION ALL

SELECT 
    'Trigger' AS object_type,
    trigger_name,
    status
FROM dba_triggers 
WHERE trigger_name LIKE 'AUTO_GRANT%'

UNION ALL

SELECT 
    'User' AS object_type,
    username,
    account_status
FROM dba_users 
WHERE username = 'USERQALCH'

ORDER BY object_type, object_name;
```

---

## üéØ R√©sultat attendu du test complet
```
OBJECT_TYPE   OBJECT_NAME                         STATUS
-----------   ----------------------------------  -------
Procedure     GRANT_QA_ROLE_ACCESS_TO_SCHEMA     VALID
Role          QA_ROLE                            (null)
Trigger       AUTO_GRANT_LUCA_TO_QA_ROLE         ENABLED
User          USERQALCH                          OPEN

üî• Test final : V√©rifier le trigger automatique
Pour vraiment tester que le trigger fonctionne :
sql-- 1. Se connecter avec le propri√©taire du sch√©ma LUCA
-- CONNECT luca/password

-- 2. Cr√©er une table de test
CREATE TABLE LUCA.TEST_AUTO_GRANT (
    id NUMBER,
    nom VARCHAR2(100)
);

-- 3. V√©rifier que QA_ROLE a automatiquement les privil√®ges
SELECT grantee, privilege 
FROM dba_tab_privs 
WHERE table_name = 'TEST_AUTO_GRANT' 
  AND owner = 'LUCA'
  AND grantee = 'QA_ROLE';

-- R√©sultat attendu :
-- GRANTEE   PRIVILEGE
-- QA_ROLE   ALTER
-- QA_ROLE   DELETE
-- QA_ROLE   INDEX
-- QA_ROLE   INSERT
-- QA_ROLE   SELECT
-- QA_ROLE   UPDATE
-- etc. (ALL PRIVILEGES)

-- 4. Tester avec userqalch
-- CONNECT userqalch/ChangeMe1234!
SELECT * FROM LUCA.TEST_AUTO_GRANT;
-- ‚úÖ Devrait fonctionner !

INSERT INTO LUCA.TEST_AUTO_GRANT VALUES (1, 'Test');
-- ‚úÖ Devrait fonctionner !
