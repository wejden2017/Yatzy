- name: Install required packages (ksh + unzip) via raw
  ansible.builtin.raw: sudo yum install -y ksh unzip
  register: install_packages
  changed_when: "'Complete!' in install_packages.stdout"
  become: true


- name: Create group
  ansible.builtin.group:
    name: "{{ vtom_group }}"
    state: present

- name: Create user
  ansible.builtin.user:
    name: "{{ vtom_user }}"
    group: "{{ vtom_group }}"
    shell: /bin/ksh
    home: "/home/{{ vtom_user }}"
    create_home: true
    state: present

- name: Add user to wheel group
  ansible.builtin.user:
    name: "{{ vtom_user }}"
    groups: wheel
    append: yes

- name: Create installation base directory
  ansible.builtin.file:
    path: "{{ vtom_install_dir | dirname }}"
    state: directory
    owner: "{{ vtom_user }}"
    group: "{{ vtom_group }}"
    mode: '0755'

- name: Create temp install directory on EC2
  ansible.builtin.file:
    path: "{{ vtom_tmp_dir }}"
    state: directory
    owner: "{{ vtom_user }}"
    group: "{{ vtom_group }}"
    mode: '0755'

- name: Download VTOM install files from S3 (directly from EC2)
  amazon.aws.aws_s3:
    bucket: "{{ vtom_s3_bucket }}"
    object: "{{ item }}"
    dest: "{{ vtom_tmp_dir }}/{{ item }}"
    mode: get
  loop: "{{ vtom_files }}"
  when: do_install | bool
