SET DEFINE OFF
SET SERVEROUTPUT ON SIZE UNLIMITED
SET FEEDBACK OFF
SET VERIFY OFF
SET HEADING OFF
SET ECHO OFF
WHENEVER SQLERROR EXIT SQL.SQLCODE

DECLARE
  v_user    VARCHAR2(128) := UPPER('{{ item.login }}');
  v_pwd     VARCHAR2(512) := '{{ item.password | default(_default_password) }}';
  v_action  VARCHAR2(30)  := LOWER('{{ item.action | default("create") }}');
  v_cnt     INTEGER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_cnt
    FROM dba_users
   WHERE username = v_user;

  IF v_cnt = 0 THEN
    -- =====================================================
    --  User n'existe pas encore
    -- =====================================================
    IF v_action IN ('create','reset-password','unlock','') THEN
      DBMS_OUTPUT.PUT_LINE('Creating user '||v_user||' ...');

      EXECUTE IMMEDIATE
            'CREATE USER '||v_user||
            ' IDENTIFIED BY "'||REPLACE(v_pwd,'"','""')||'"'
            || ' DEFAULT TABLESPACE USERS'
            || ' TEMPORARY TABLESPACE TEMP'
            || ' ACCOUNT UNLOCK';

    ELSIF v_action = 'lock' THEN
      DBMS_OUTPUT.PUT_LINE('User '||v_user||' does not exist; nothing to lock.');
      RETURN;
    ELSE
      DBMS_OUTPUT.PUT_LINE('Unknown action '||v_action||' for new user '||v_user||'; doing nothing.');
      RETURN;
    END IF;

  ELSE
    -- =====================================================
    --  User existe déjà
    -- =====================================================
    IF v_action IN ('create','reset-password','') THEN
      DBMS_OUTPUT.PUT_LINE('User '||v_user||' exists; resetting password ...');
      EXECUTE IMMEDIATE
            'ALTER USER '||v_user||
            ' IDENTIFIED BY "'||REPLACE(v_pwd,'"','""')||'"'
            || ' ACCOUNT UNLOCK';

    ELSIF v_action = 'lock' THEN
      DBMS_OUTPUT.PUT_LINE('Locking user '||v_user||' ...');
      EXECUTE IMMEDIATE 'ALTER USER '||v_user||' ACCOUNT LOCK';

    ELSIF v_action = 'unlock' THEN
      DBMS_OUTPUT.PUT_LINE('Unlocking user '||v_user||' ...');
      EXECUTE IMMEDIATE 'ALTER USER '||v_user||' ACCOUNT UNLOCK';

    ELSE
      DBMS_OUTPUT.PUT_LINE('Unknown action '||v_action||' for existing user '||v_user||'; doing nothing.');
    END IF;
  END IF;

  -- =====================================================
  --  Grant CREATE SESSION (idempotent)
  -- ======================================
