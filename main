#!/bin/ksh

. ${HOME}/env/env.ksh
. ${CATS_OPER}/common_functions.sh

LOG_SCRIPT=${CATS_LOG}/`basename $0 ".ksh"`.log
nom_script=`basename $0 "@@"`
exec 1>>"$LOG_SCRIPT" 2>>"$LOG_SCRIPT"

LOGINFO "${nom_script}" "Début" | tee -a "$LOG_GENERAL"
LOGSTART "${nom_script}"

SWIFT_DIR="${DATA_SWIFT_DISPATCHER_OUT}"
SWIFT_ERR_DIR="${DATA_SWIFT_ERROR}"
APF_DIR="${DATA_APF}"
SCRIPT_T2="${SHELL_REP}/T2_integration_message_swift.ksh"
SCRIPT_CALYPSO_TYPE="${SHELL_REP}/CALYPSO_generer_msg_type.ksh"

found=0
for src in "${SWIFT_DIR}"/MTFINR*
do
  [ -e "$src" ] || continue
  found=1
  fname="$(basename "$src")"
  LOGINFO "${nom_script}" "Fichier détecté : $fname"

  if ! mv "$src" "${APF_DIR}/$fname"; then
    LOGERR "${nom_script}" "mv KO: ${src} -> ${APF_DIR}/$fname"
    continue
  fi

  if ! "${SCRIPT_T2}" "$fname"; then
    LOGERR "${nom_script}" "T2_integration_messages_swift orchestrateur KO pour $fname"
    cp -p "${APF_DIR}/$fname" "${SWIFT_ERR_DIR}/" 2>/dev/null
    continue
  fi

  if ! "${SCRIPT_CALYPSO_TYPE}" "DEPO"; then
    LOGERR "${nom_script}" "CALYPSO_generer_msg_type KO (DEPO) pour $fname"
    cp -p "${APF_DIR}/$fname" "${SWIFT_ERR_DIR}/" 2>/dev/null
    continue
  fi

  if ! "${SCRIPT_CALYPSO_TYPE}" "MRGN"; then
    LOGERR "${nom_script}" "CALYPSO_generer_msg_type KO (MRGN) pour $fname"
    cp -p "${APF_DIR}/$fname" "${SWIFT_ERR_DIR}/" 2>/dev/null
    continue
  fi
done

[ $found -eq 0 ] && LOGERR "${nom_script}" "Aucun fichier MTFINR* trouvé dans ${SWIFT_DIR}"

LOGEND "${nom_script}" "Fin" | tee -a "$LOG_GENERAL"
exit 0
