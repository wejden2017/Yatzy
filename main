#!/bin/ksh

. ${HOME}/env/env.ksh
. ${CATS_OPER}/common_functions.sh

LOG_SCRIPT=${CATS_LOG}/`basename $0 ".ksh"`.log
nom_script=`basename $0 "@@"`
exec 1>>"$LOG_SCRIPT" 2>>"$LOG_SCRIPT"

LOGINFO "${nom_script}" "Début" | tee -a "$LOG_GENERAL"
LOGSTART "${nom_script}"

SWIFT_DIR="${DATA_SWIFT_DISPATCHER_OUT}"
SWIFT_ERR_DIR="${DATA_SWIFT_ERROR}"
APF_DIR="${DATA_APF}"
SCRIPT_T2="${SHELL_REP}/T2_integration_messages_swift.ksh"
SCRIPT_CALYPSO_TYPE="${SHELL_REP}/CALYPSO_generer_msg_type.ksh"

mkdir -p "${SWIFT_ERR_DIR}"

found=0
for src in "${SWIFT_DIR}"/MTFINR*
do
  [ -e "$src" ] || continue
  found=1
  fname="$(basename "$src")"
  LOGINFO "${nom_script}" "Fichier détecté : $fname"

  mv "$src" "${APF_DIR}/$fname"
  rc=$?
  CHECK_RETURN_CODE_CATS "${nom_script}" $rc "mv ${src} -> ${APF_DIR}/$fname"
  [ $rc -ne 0 ] && continue

  "${SCRIPT_T2}" "$fname"
  rc=$?
  if [ $rc -ne 0 ]; then
    LOGERR "${nom_script}" "Etape 3 KO (rc=$rc) pour $fname"
    cp "${APF_DIR}/$fname" "${SWIFT_ERR_DIR}/"
    CHECK_RETURN_CODE_CATS "${nom_script}" $rc "T2_integration_messages_swift.ksh KO"
    continue
  fi

  "${SCRIPT_CALYPSO_TYPE}" "DEPO"
  rc=$?
  if [ $rc -ne 0 ]; then
    LOGERR "${nom_script}" "Etape 4 KO (rc=$rc) pour $fname"
    cp "${APF_DIR}/$fname" "${SWIFT_ERR_DIR}/"
    CHECK_RETURN_CODE_CATS "${nom_script}" $rc "CALYPSO_generer_msg_type.ksh DEPO KO"
    continue
  fi

  "${SCRIPT_CALYPSO_TYPE}" "MRGN"
  rc=$?
  if [ $rc -ne 0 ]; then
    LOGERR "${nom_script}" "Etape 5 KO (rc=$rc) pour $fname"
    cp "${APF_DIR}/$fname" "${SWIFT_ERR_DIR}/"
    CHECK_RETURN_CODE_CATS "${nom_script}" $rc "CALYPSO_generer_msg_type.ksh MRGN KO"
    continue
  fi
done

[ $found -eq 0 ] && LOGERR "${nom_script}" "Aucun fichier MTFINR* trouvé dans ${SWIFT_DIR}"

LOGEND "${nom_script}" "Fin" | tee -a "$LOG_GENERAL"
exit 0
