-- =========================================
-- Drop user (generated by Ansible)
-- Env : {{ lookup('env','ENV') | default('UNKNOWN') | upper }}
-- User: {{ item.login | upper }}
-- =========================================

SET SERVEROUTPUT ON SIZE UNLIMITED
SET FEEDBACK OFF
SET VERIFY OFF
SET HEADING OFF
SET ECHO OFF

DECLARE
    v_user      VARCHAR2(128) := UPPER('{{ item.login }}');
    v_user_id   NUMBER;
    v_exists    NUMBER := 0;
BEGIN
    -- 1) Sécurité : ne JAMAIS dropper LUCA
    IF v_user = 'LUCA' THEN
        DBMS_OUTPUT.PUT_LINE('Safeguard: refusing to drop LUCA.');
        RETURN;
    END IF;

    -- 2) Vérifier que l'utilisateur existe
    SELECT COUNT(*)
      INTO v_exists
      FROM dba_users
     WHERE username = v_user;

    IF v_exists = 0 THEN
        DBMS_OUTPUT.PUT_LINE('User '||v_user||' does not exist; nothing to drop.');
        RETURN;
    END IF;

    -- 3) Récupérer USER_ID pour retrouver les sessions proxy
    SELECT user_id
      INTO v_user_id
      FROM dba_users
     WHERE username = v_user;

    DBMS_OUTPUT.PUT_LINE(
        'User '||v_user||
        ' exists (USER_ID='||v_user_id||'); searching sessions to kill...'
    );

    -- 4) Tuer les sessions directes ET proxy
    FOR s IN (
        SELECT sid, serial#, inst_id
          FROM gv$session
         WHERE type = 'USER'
           AND username IS NOT NULL
           AND (
                 username    = v_user      -- connexions directes
              OR proxy_user# = v_user_id   -- connexions via proxy (ex: SEYDOU[LUCA])
           )
    ) LOOP
        BEGIN
            DBMS_OUTPUT.PUT_LINE(
                'Killing session '||s.sid||','||s.serial#||' @ '||s.inst_id||' ...'
            );
            EXECUTE IMMEDIATE
                'ALTER SYSTEM KILL SESSION '''||
                    s.sid||','||s.serial#||',@'||s.inst_id||''' IMMEDIATE';
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE(
                    'Could not kill session '||s.sid||','||s.serial#||
                    ' : '||SQLERRM
                );
        END;
    END LOOP;

    -- 5) Petite pause pour laisser Oracle nettoyer les sessions
    BEGIN
        DBMS_LOCK.SLEEP(1);
    EXCEPTION
        WHEN OTHERS THEN NULL;
    END;

    -- 6) Tentatives de DROP avec gestion de ORA-01940 (user still connected)
    FOR attempt IN 1 .. 3 LOOP
        BEGIN
            DBMS_OUTPUT.PUT_LINE(
                'Attempt '||attempt||
                ' to drop user '||v_user||' CASCADE ...'
            );
            EXECUTE IMMEDIATE 'DROP USER '||v_user||' CASCADE';
            DBMS_OUTPUT.PUT_LINE('User '||v_user||' dropped.');
            EXIT; -- succès, on sort de la boucle
        EXCEPTION
            WHEN OTHERS THEN
                IF SQLCODE = -1940 AND attempt < 3 THEN
                    DBMS_OUTPUT.PUT_LINE(
                        'ORA-01940 (user still connected) on attempt '||
                        attempt||'; retrying after small sleep...'
                    );
                    BEGIN
                        DBMS_LOCK.SLEEP(1);
                    EXCEPTION
                        WHEN OTHERS THEN NULL;
                    END;
                ELSE
                    DBMS_OUTPUT.PUT_LINE(
                        'ERROR dropping '||v_user||' : '||SQLERRM
                    );
                    RAISE;
                END IF;
        END;
    END LOOP;
END;
/
