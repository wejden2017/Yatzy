-- 1) Voir les rôles actifs dans la session
SELECT * FROM session_roles ORDER BY role;

-- 2) Vérifier que QA_ROLE est bien actif
SELECT granted_role, default_role
FROM   dba_role_privs
WHERE  grantee = 'JEROME';

-- 3) Vérifier que QA_ROLE porte bien CREATE ANY TABLE
SELECT privilege
FROM   dba_sys_privs
WHERE  grantee = 'QA_ROLE'
ORDER  BY privilege;

-- 4) Vérifier que JEROME voit bien CREATE ANY TABLE via les rôles
SELECT DISTINCT privilege, admin_option
FROM   dba_sys_privs
WHERE  grantee IN (
  'JEROME',
  'QA_ROLE'
)
ORDER BY grantee, privilege;


SET ROLE QA_ROLE;


-- test simple de CREATE ANY TABLE dans LUCA
CREATE TABLE LUCA.ZZ_TEST_PRIV (ID NUMBER);


SELECT owner, trigger_name, trigger_type, triggering_event, table_owner, base_object_type
FROM   dba_triggers
WHERE  base_object_type = 'DATABASE'
ORDER  BY owner, trigger_name;

GRANT CREATE ANY TABLE TO JEROME;

SELECT owner, trigger_name, status
FROM   dba_triggers
WHERE  trigger_name LIKE 'TRG_AUTO_GRANT_%'
ORDER BY owner, trigger_name;

SELECT owner, object_name, status
FROM   dba_objects
WHERE  object_name = 'TRG_AUTO_GRANT_QA_ROLE'
AND    owner = 'LUCA';

SELECT trigger_name,
       triggering_event,
       base_object_type,
       table_name
FROM   dba_triggers
WHERE  trigger_name = 'TRG_AUTO_GRANT_QA_ROLE'
AND    owner = 'LUCA';

CREATE TABLE LUCA.DDL_AUTO_GRANT_LOG (
  log_id       NUMBER GENERATED BY DEFAULT AS IDENTITY,
  log_date     DATE,
  username     VARCHAR2(30),
  obj_owner    VARCHAR2(30),
  obj_type     VARCHAR2(30),
  obj_name     VARCHAR2(128),
  sql_text     VARCHAR2(4000)
);

