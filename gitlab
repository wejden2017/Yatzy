D‚Äôabord : lister ce qui existe (pour ne rien casser)

√Ä faire en SYS (ou user DBA) :

a) Ancien triggers ‚Äúauto grant‚Äù par sch√©ma
SELECT owner, trigger_name
FROM   dba_triggers
WHERE  trigger_name LIKE 'TRG_AUTO_GRANT_%'
ORDER BY owner, trigger_name;

b) Ancien triggers de s√©curit√©
SELECT owner, trigger_name
FROM   dba_triggers
WHERE  trigger_name IN (
  'TRG_SECURITY_SCHEMA_ACCESS',
  'TRG_BLOCK_DDL_ON_SYSTEM_SCHEMAS',
  'TRG_BLOCK_DROP_EXCEPT_LUCA'
)
ORDER BY owner, trigger_name;

c) Anciens r√¥les ‚Äúpar sch√©ma‚Äù

Si tu avais des r√¥les du type QA_LUCA_ROLE, DEV_LUCA1_ROLE, etc. :

SELECT role
FROM   dba_roles
WHERE  role LIKE '%\_LUCA\_ROLE' ESCAPE '\'
   OR  role LIKE 'DEV\_%\_ROLE' ESCAPE '\'
   OR  role LIKE 'QA\_%\_ROLE'  ESCAPE '\'
ORDER BY role;

2Ô∏è‚É£ Nettoyage des TRIGGERS
a) Drop des anciens triggers ‚Äúauto-grant‚Äù par sch√©ma

Exemple g√©n√©rique :

DECLARE
  CURSOR c_trg IS
    SELECT owner, trigger_name
    FROM   dba_triggers
    WHERE  trigger_name LIKE 'TRG_AUTO_GRANT_%'
       AND owner IN ('LUCA','LUCA1','LUCA2','LUCA3','LUCA4','LUCA5','LUCA6','LUCA7','LUCA8','LUCA9');
BEGIN
  FOR r IN c_trg LOOP
    EXECUTE IMMEDIATE 'DROP TRIGGER ' || r.owner || '.' || r.trigger_name;
  END LOOP;
END;
/

b) Drop des anciens triggers de s√©curit√© (si tu ne veux garder que le nouveau mod√®le)
DECLARE
  CURSOR c_trg IS
    SELECT owner, trigger_name
    FROM   dba_triggers
    WHERE  trigger_name IN (
      'TRG_SECURITY_SCHEMA_ACCESS',
      'TRG_BLOCK_DDL_ON_SYSTEM_SCHEMAS',
      'TRG_BLOCK_DROP_EXCEPT_LUCA'
    );
BEGIN
  FOR r IN c_trg LOOP
    EXECUTE IMMEDIATE 'DROP TRIGGER ' || r.owner || '.' || r.trigger_name;
  END LOOP;
END;
/


Ensuite, tu laisses :

ton nouveau trigger global SYS.TRG_AUTO_GRANT_ROLES,

et √©ventuellement un trigger simple de protection des sch√©mas syst√®me si tu en gardes un.

3Ô∏è‚É£ Nettoyage des R√îLES (‚ö†Ô∏è avec prudence)
a) Voir quels users ont encore les anciens r√¥les

Avant de DROP un r√¥le, regarde qui l‚Äôa :

SELECT granted_role, grantee, admin_option, default_role
FROM   dba_role_privs
WHERE  granted_role LIKE '%\_LUCA\_ROLE' ESCAPE '\'
    OR granted_role LIKE 'DEV\_%\_ROLE' ESCAPE '\'
    OR granted_role LIKE 'QA\_%\_ROLE'  ESCAPE '\'
ORDER BY granted_role, grantee;

b) Rebasculer les utilisateurs nominatif sur les nouveaux r√¥les

Par exemple :

GRANT DEV_ROLE TO JEROME;
GRANT QA_ROLE  TO JEROME;

-- et pour les autres :
GRANT QA_ROLE  TO SALMA;
GRANT QA_ROLE  TO SEYDOU;
-- etc.

c) Puis seulement ensuite : DROP des anciens r√¥les

Quand tu es s√ªr qu‚Äôils ne sont plus utilis√©s :

DECLARE
  CURSOR c_roles IS
    SELECT role
    FROM   dba_roles
    WHERE  role LIKE '%\_LUCA\_ROLE' ESCAPE '\'
       OR  role LIKE 'DEV\_%\_ROLE' ESCAPE '\'
       OR  role LIKE 'QA\_%\_ROLE'  ESCAPE '\';
BEGIN
  FOR r IN c_roles LOOP
    EXECUTE IMMEDIATE 'DROP ROLE ' || r.role;
  END LOOP;
END;
/


üëâ Ne touche pas aux users nominatif (JEROME, SALMA, etc.), tu fais juste √©voluer leurs r√¥les.

En clair

‚úÖ Oui, c‚Äôest la bonne id√©e de faire du m√©nage (triggers + anciens r√¥les).

‚úÖ Fais-le dans cet ordre :

Lister ‚Üí v√©rifier ce qui existe.

Drop les vieux triggers (TRG_AUTO_GRANT_*, anciens triggers RLS/secure).

Donner les nouveaux r√¥les globaux (DEV_ROLE, QA_ROLE, UAT_ROLE) √† tes users.

Drop les vieux r√¥les ‚Äúpar sch√©ma‚Äù quand plus personne ne les a.

Si tu veux, tu peux ensuite me coller ton fichier template Ansible de ‚Äúcleanup‚Äù et je te le resserre propre en version finale.
