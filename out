#!/bin/ksh
# ============================================================================
# Vérifie la présence des fichiers CAL_TO_CAT_*.CSV/.csv et appelle
# le script d’intégration pour chacun. Pas de gestion d’échec.
# ============================================================================

DATA_DIR="/cats/oper/data/apf"
SCRIPT_SHARED="/cats/oper/exe/SharedApps/CALYPSO_integration_csv.ksh"
LOG_FILE="/cats/oper/logs/traitement_CALYPSO_integration_csv.log"

# Création dossier logs
mkdir -p "$(dirname "$LOG_FILE")"

# Redirige tout vers le log
exec 1>>"$LOG_FILE" 2>&1

echo "=== Début traitement $(date '+%Y-%m-%d %H:%M:%S') ==="

found=0
for file in "${DATA_DIR}"/CAL_TO_CAT_*.[cC][sS][vV]
do
  [ -e "$file" ] || continue
  found=1
  echo "$(date '+%Y-%m-%d %H:%M:%S') - Détection fichier : $file"
  "$SCRIPT_SHARED" "$file"
done

if [ $found -eq 0 ]; then
  echo "$(date '+%Y-%m-%d %H:%M:%S') - Aucun fichier trouvé dans $DATA_DIR"
fi

echo "=== Fin traitement $(date '+%Y-%m-%d %H:%M:%S') ==="
exit 0


#!/bin/ksh
# ============================================================================
# Traite un fichier puis le renomme en <fichier>_traite
# ============================================================================
LOG_FILE="/cats/oper/logs/CALYPSO_integration_csv.log"

exec 1>>"$LOG_FILE" 2>&1

file="$1"

if [ -z "$file" ]; then
  echo "$(date '+%Y-%m-%d %H:%M:%S') - Usage: $0 <fichier>"
  exit 1
fi

echo "$(date '+%Y-%m-%d %H:%M:%S') - Début traitement du fichier : $file"

mv "$file" "${file}_traite"

echo "$(date '+%Y-%m-%d %H:%M:%S') - Succès : $file renommé en ${file}_traite"
exit 0

