#!/bin/ksh
# ============================================================================
# Vérifie la présence des fichiers CAL_TO_CAT_*.CSV et appelle
# le script d’intégration pour chacun.
# Logs et fonctions standards CATS.
# ============================================================================

. ${HOME}/env/env.ksh
. ${CATS_OPER}/common_functions.sh

LOG_SCRIPT=${CATS_LOG}/`basename $0 ".ksh"`.log
nom_script=`basename $0 "@@"`
exec 1>>"$LOG_SCRIPT" 2>>"$LOG_SCRIPT"

LOGINFO "${nom_script}" "Début" | tee -a "$LOG_GENERAL"
LOGSTART "${nom_script}"

DATA_DIR="${CATS_OPER}/data/apf"
SCRIPT_SHARED="${CATS_OPER}/exe/SharedApps/CALYPSO_integration_csv.ksh"

found=0
for file in ${DATA_DIR}/CAL_TO_CAT_*.[cC][sS][vV]
do
  [ -e "$file" ] || continue
  found=1
  LOGINFO "${nom_script}" "Détection fichier : $file"
  $SCRIPT_SHARED "$file"
done

if [ $found -eq 0 ]; then
  LOGERR "${nom_script}" "Aucun fichier trouvé dans $DATA_DIR"
fi

LOGEND "${nom_script}" "Fin" | tee -a "$LOG_GENERAL"
exit 0
///////////////
#!/bin/ksh
# ============================================================================
# Traite un fichier CSV CALYPSO et le renomme en <fichier>_traite
# Logs et fonctions standards CATS.
# ============================================================================

. ${HOME}/env/env.ksh
. ${CATS_OPER}/common_functions.sh

LOG_SCRIPT=${CATS_LOG}/`basename $0 ".ksh"`.log
nom_script=`basename $0 "@@"`
exec 1>>"$LOG_SCRIPT" 2>>"$LOG_SCRIPT"

LOGINFO "${nom_script}" "Début" | tee -a "$LOG_GENERAL"
LOGSTART "${nom_script}"

file="$1"

if [ -z "$file" ]; then
  LOGERR "${nom_script}" "Usage: $0 <fichier>"
  CHECK_RETURN_CODE_CATS "${nom_script}" 1 "Paramètre manquant"
fi

LOGINFO "${nom_script}" "Début traitement du fichier : $file"

mv "$file" "${file}_traite"

LOGINFO "${nom_script}" "Succès : $file renommé en ${file}_traite"

LOGEND "${nom_script}" "Fin" | tee -a "$LOG_GENERAL"
exit 0
